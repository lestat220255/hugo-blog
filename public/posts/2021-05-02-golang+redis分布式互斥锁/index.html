<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Golang+Redisåˆ†å¸ƒå¼äº’æ–¥é” | Lester's Blog</title><meta name=keywords content="golang,redis"><meta name=description content="è‡ªåŠ¨é‡è¯•,è‡ªåŠ¨ç»­æœŸ"><meta name=author content><link rel=canonical href=https://blog.88886688.xyz/posts/2021-05-02-golang+redis%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%92%E6%96%A5%E9%94%81/><link crossorigin=anonymous href=/assets/css/stylesheet.84a638ec294a2a547ea8ea3f2466d240b38b987cbbb815b534c0442ed8d517d7.css integrity="sha256-hKY47ClKKlR+qOo/JGbSQLOLmHy7uBW1NMBELtjVF9c=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.88886688.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.88886688.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.88886688.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.88886688.xyz/apple-touch-icon.png><link rel=mask-icon href=https://blog.88886688.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Golang+Redisåˆ†å¸ƒå¼äº’æ–¥é”"><meta property="og:description" content="è‡ªåŠ¨é‡è¯•,è‡ªåŠ¨ç»­æœŸ"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.88886688.xyz/posts/2021-05-02-golang+redis%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%92%E6%96%A5%E9%94%81/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-02T22:39:11+00:00"><meta property="article:modified_time" content="2021-05-02T22:39:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Golang+Redisåˆ†å¸ƒå¼äº’æ–¥é”"><meta name=twitter:description content="è‡ªåŠ¨é‡è¯•,è‡ªåŠ¨ç»­æœŸ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.88886688.xyz/posts/"},{"@type":"ListItem","position":2,"name":"Golang+Redisåˆ†å¸ƒå¼äº’æ–¥é”","item":"https://blog.88886688.xyz/posts/2021-05-02-golang+redis%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%92%E6%96%A5%E9%94%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Golang+Redisåˆ†å¸ƒå¼äº’æ–¥é”","name":"Golang\u002bRedisåˆ†å¸ƒå¼äº’æ–¥é”","description":"è‡ªåŠ¨é‡è¯•,è‡ªåŠ¨ç»­æœŸ","keywords":["golang","redis"],"articleBody":"å¼•è¨€ å‡è®¾æˆ‘ä»¬çš„æŸä¸ªä¸šåŠ¡ä¼šæ¶‰åŠæ•°æ®æ›´æ–°ï¼ŒåŒæ—¶åœ¨å®é™…åœºæ™¯ä¸­æœ‰è¾ƒå¤§å¹¶å‘é‡ã€‚æµç¨‹:è¯»å–-\u003eä¿®æ”¹-\u003eä¿å­˜ï¼Œåœ¨ä¸è€ƒè™‘åŸºäºDBå±‚çš„å¹¶å‘å¤„ç†æƒ…å†µä¸‹ï¼Œè¿™ç§åœºæ™¯å¯èƒ½å¯¹éƒ¨åˆ†æ•°æ®é€ æˆä¸å¯é¢„æœŸçš„æ‰§è¡Œç»“æœï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¯¥é—®é¢˜\néœ€è¦è§£å†³çš„é—®é¢˜ é”çš„è¯¯è§£é™¤ ä¸šåŠ¡æ‰§è¡Œè¶…æ—¶å¯¼è‡´å¹¶å‘ é‡è¯•æœºåˆ¶ GETå’ŒDELéåŸå­æ€§ ä»£ç  ç›®å½•ç»“æ„:\nâ”‚ main.go â”‚ â””â”€demo lock.go lock.go:\npackage demo import ( \"context\" \"fmt\" \"github.com/go-redis/redis/v8\" \"math/rand\" \"time\" ) // é‡è¯•æ¬¡æ•° var retryTimes = 5 // é‡è¯•é¢‘ç‡ var retryInterval = time.Millisecond * 50 var rdb = redis.NewClient(\u0026redis.Options{ Addr: \"localhost:6379\", Password: \"\", // no password set DB: 0, // use default DB }) // é”çš„é»˜è®¤è¿‡æœŸæ—¶é—´ var expiration time.Duration // æ¨¡æ‹Ÿåˆ†å¸ƒå¼ä¸šåŠ¡åŠ é”åœºæ™¯ func MockTest(tag string) { var ctx, cancel = context.WithCancel(context.Background()) defer func() { // åœæ­¢goroutine cancel() }() // éšæœºvalue lockV := getRandValue() lockK := \"EXAMPLE_LOCK\" // é»˜è®¤è¿‡æœŸæ—¶é—´ expiration = time.Millisecond * 200 fmt.Println(tag + \"å°è¯•åŠ é”\") set, err := rdb.SetNX(ctx, lockK, lockV, expiration).Result() if err != nil { panic(err.Error()) } // åŠ é”å¤±è´¥,é‡è¯• if set == false \u0026\u0026 retry(ctx, rdb, lockK, lockV, expiration, tag) == false { fmt.Println(tag + \" server unavailable, try again later\") return } fmt.Println(tag + \"æˆåŠŸåŠ é”\") // åŠ é”æˆåŠŸ,æ–°å¢å®ˆæŠ¤çº¿ç¨‹ go watchDog(ctx, rdb, lockK, expiration, tag) // å¤„ç†ä¸šåŠ¡(é€šè¿‡éšæœºæ—¶é—´å»¶è¿Ÿæ¨¡æ‹Ÿ) fmt.Println(tag + \"ç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ...\") time.Sleep(getRandDuration()) // ä¸šåŠ¡å¤„ç†å®Œæˆ // é‡Šæ”¾é” val := delByKeyWhenValueEquals(ctx, rdb, lockK, lockV) fmt.Println(tag+\"é‡Šæ”¾ç»“æœ:\", val) } // é‡Šæ”¾é” func delByKeyWhenValueEquals(ctx context.Context, rdb *redis.Client, key string, value interface{}) bool { lua := ` -- å¦‚æœå½“å‰å€¼ä¸é”å€¼ä¸€è‡´,åˆ é™¤key if redis.call('GET', KEYS[1]) == ARGV[1] then return redis.call('DEL', KEYS[1]) else return 0 end ` scriptKeys := []string{key} val, err := rdb.Eval(ctx, lua, scriptKeys, value).Result() if err != nil { panic(err.Error()) } return val == int64(1) } // ç”Ÿæˆéšæœºæ—¶é—´ func getRandDuration() time.Duration { rand.Seed(time.Now().UnixNano()) min := 50 max := 100 return time.Duration(rand.Intn(max-min)+min) * time.Millisecond } // ç”Ÿæˆéšæœºå€¼ func getRandValue() int { rand.Seed(time.Now().UnixNano()) return rand.Int() } // å®ˆæŠ¤çº¿ç¨‹ func watchDog(ctx context.Context, rdb *redis.Client, key string, expiration time.Duration, tag string) { for { select { // ä¸šåŠ¡å®Œæˆ case \u003c-ctx.Done(): fmt.Printf(\"%sä»»åŠ¡å®Œæˆ,å…³é—­%sçš„è‡ªåŠ¨ç»­æœŸ\\n\", tag, key) return // ä¸šåŠ¡æœªå®Œæˆ default: // è‡ªåŠ¨ç»­æœŸ rdb.PExpire(ctx, key, expiration) // ç»§ç»­ç­‰å¾… time.Sleep(expiration / 2) } } } // é‡è¯• func retry(ctx context.Context, rdb *redis.Client, key string, value interface{}, expiration time.Duration, tag string) bool { i := 1 for i \u003c= retryTimes { fmt.Printf(tag+\"ç¬¬%dæ¬¡å°è¯•åŠ é”ä¸­...\\n\", i) set, err := rdb.SetNX(ctx, key, value, expiration).Result() if err != nil { panic(err.Error()) } if set == true { return true } time.Sleep(retryInterval) i++ } return false } æµç¨‹è¯´æ˜ å‡è®¾MockTestæ–¹æ³•å°±æ˜¯ä¸šåŠ¡å¤„ç†æ–¹æ³•\nåˆå§‹åŒ–contextç”¨äºæ§åˆ¶å®ˆæŠ¤çº¿ç¨‹çš„é€€å‡º è®¾ç½®éšæœºå€¼å°è¯•åŠ é”(éšæœºå€¼åœ¨é‡Šæ”¾é”æ—¶å¯é¿å…è¯¯é‡Šæ”¾) å¦‚æœåŠ é”ä¸æˆåŠŸ,å°è¯•é‡è¯•,é‡è¯•æœºåˆ¶æ ¹æ®ä¸šåŠ¡è€Œå®š,é‡è¯•å¤±è´¥å¤„ç†æ ¹æ®ä¸šåŠ¡è€Œå®š æˆåŠŸåŠ é”åå¼€å¯ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹(watchDog),ç”¨äºæŒç»­åˆ·æ–°é”çš„è¿‡æœŸæ—¶é—´,ä¿è¯åœ¨ä¸šåŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é”ä¸ä¼šè¿‡æœŸ æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†éšæœºè€—æ—¶ ä¸šåŠ¡å¤„ç†å®Œæˆåé‡Šæ”¾é”(luaå¤„ç†ä¿è¯åŸå­æ€§,å¹¶å¯¹æ¯”valueé¿å…è¯¯é‡Šæ”¾) é€šè¿‡cancelå…³é—­å®ˆæŠ¤çº¿ç¨‹(watchDog),é¿å…æ­»é” åº”å¯¹åœºæ™¯ çº¿ç¨‹è·å–åˆ°é”åå¼‚å¸¸ç»ˆæ­¢,é”ä¼šåœ¨expireåˆ°æœŸåè‡ªåŠ¨é‡Šæ”¾ çº¿ç¨‹æ‰§è¡Œæ—¶é—´è¶…å‡ºé”çš„é»˜è®¤expire,é€šè¿‡watchDogè‡ªåŠ¨ç»­æœŸ,é¿å…è¯¥æƒ…å†µå‘ç”Ÿ æµ‹è¯• main.go:\npackage main import ( \"play/demo\" \"time\" ) func main() { go demo.MockTest(\"A\") go demo.MockTest(\"B\") go demo.MockTest(\"C\") go demo.MockTest(\"D\") go demo.MockTest(\"E\") // ç”¨äºæµ‹è¯•goroutineæ¥æ”¶åˆ°ctx.Done()ä¿¡å·åçš„æ‰“å° time.Sleep(time.Second * 2) } ç»“æœ:\n$ go run main.go Aå°è¯•åŠ é” Då°è¯•åŠ é” Eå°è¯•åŠ é” Bå°è¯•åŠ é” Cå°è¯•åŠ é” DæˆåŠŸåŠ é” Dç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ... Bç¬¬1æ¬¡å°è¯•åŠ é”ä¸­... Eç¬¬1æ¬¡å°è¯•åŠ é”ä¸­... Aç¬¬1æ¬¡å°è¯•åŠ é”ä¸­... Cç¬¬1æ¬¡å°è¯•åŠ é”ä¸­... Bç¬¬2æ¬¡å°è¯•åŠ é”ä¸­... Dé‡Šæ”¾ç»“æœ: true BæˆåŠŸåŠ é” Eç¬¬2æ¬¡å°è¯•åŠ é”ä¸­... Bç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ... Cç¬¬2æ¬¡å°è¯•åŠ é”ä¸­... Aç¬¬2æ¬¡å°è¯•åŠ é”ä¸­... Dä»»åŠ¡å®Œæˆ,å…³é—­EXAMPLE_LOCKçš„è‡ªåŠ¨ç»­æœŸ Aç¬¬3æ¬¡å°è¯•åŠ é”ä¸­... Cç¬¬3æ¬¡å°è¯•åŠ é”ä¸­... Eç¬¬3æ¬¡å°è¯•åŠ é”ä¸­... Bé‡Šæ”¾ç»“æœ: true AæˆåŠŸåŠ é” Aç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ... Bä»»åŠ¡å®Œæˆ,å…³é—­EXAMPLE_LOCKçš„è‡ªåŠ¨ç»­æœŸ Eç¬¬4æ¬¡å°è¯•åŠ é”ä¸­... Cç¬¬4æ¬¡å°è¯•åŠ é”ä¸­... Aé‡Šæ”¾ç»“æœ: true Aä»»åŠ¡å®Œæˆ,å…³é—­EXAMPLE_LOCKçš„è‡ªåŠ¨ç»­æœŸ Cç¬¬5æ¬¡å°è¯•åŠ é”ä¸­... Eç¬¬5æ¬¡å°è¯•åŠ é”ä¸­... CæˆåŠŸåŠ é” Cç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ... E server unavailable, try again later Cé‡Šæ”¾ç»“æœ: true Cä»»åŠ¡å®Œæˆ,å…³é—­EXAMPLE_LOCKçš„è‡ªåŠ¨ç»­æœŸ å·æ‡’å°±æ²¡å†™å•å…ƒæµ‹è¯•äº†ğŸ¤¦â€\n","wordCount":"440","inLanguage":"en","datePublished":"2021-05-02T22:39:11.923Z","dateModified":"2021-05-02T22:39:11.923Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.88886688.xyz/posts/2021-05-02-golang+redis%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%92%E6%96%A5%E9%94%81/"},"publisher":{"@type":"Organization","name":"Lester's Blog","logo":{"@type":"ImageObject","url":"https://blog.88886688.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.88886688.xyz/ accesskey=h title="Lester's Blog (Alt + H)">Lester's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.88886688.xyz/ title="Lester's Blog"><span>Home</span></a></li><li><a href=https://blog.88886688.xyz/tags/ title=Tags><span>Tags/åˆ†ç±»</span></a></li><li><a href=https://blog.88886688.xyz/about/ title="About Me"><span>About/å…³äº</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.88886688.xyz/>Home</a>&nbsp;Â»&nbsp;<a href=https://blog.88886688.xyz/posts/>Posts</a></div><h1 class=post-title>Golang+Redisåˆ†å¸ƒå¼äº’æ–¥é”</h1><div class=post-description>è‡ªåŠ¨é‡è¯•,è‡ªåŠ¨ç»­æœŸ</div><div class=post-meta><span title='2021-05-02 22:39:11.923 +0000 UTC'>May 2, 2021</span>&nbsp;Â·&nbsp;3 min&nbsp;Â·&nbsp;440 words</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e8%a8%80 aria-label=å¼•è¨€>å¼•è¨€</a></li><li><a href=#%e9%9c%80%e8%a6%81%e8%a7%a3%e5%86%b3%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=éœ€è¦è§£å†³çš„é—®é¢˜>éœ€è¦è§£å†³çš„é—®é¢˜</a></li><li><a href=#%e4%bb%a3%e7%a0%81 aria-label=ä»£ç >ä»£ç </a></li><li><a href=#%e6%b5%81%e7%a8%8b%e8%af%b4%e6%98%8e aria-label=æµç¨‹è¯´æ˜>æµç¨‹è¯´æ˜</a></li><li><a href=#%e5%ba%94%e5%af%b9%e5%9c%ba%e6%99%af aria-label=åº”å¯¹åœºæ™¯>åº”å¯¹åœºæ™¯</a></li><li><a href=#%e6%b5%8b%e8%af%95 aria-label=æµ‹è¯•>æµ‹è¯•</a></li></ul></div></details></div><div class=post-content><h3 id=å¼•è¨€>å¼•è¨€<a hidden class=anchor aria-hidden=true href=#å¼•è¨€>#</a></h3><p>å‡è®¾æˆ‘ä»¬çš„æŸä¸ªä¸šåŠ¡ä¼šæ¶‰åŠæ•°æ®æ›´æ–°ï¼ŒåŒæ—¶åœ¨å®é™…åœºæ™¯ä¸­æœ‰è¾ƒå¤§å¹¶å‘é‡ã€‚æµç¨‹:è¯»å–->ä¿®æ”¹->ä¿å­˜ï¼Œåœ¨ä¸è€ƒè™‘åŸºäºDBå±‚çš„å¹¶å‘å¤„ç†æƒ…å†µä¸‹ï¼Œè¿™ç§åœºæ™¯å¯èƒ½å¯¹éƒ¨åˆ†æ•°æ®é€ æˆä¸å¯é¢„æœŸçš„æ‰§è¡Œç»“æœï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¯¥é—®é¢˜</p><h3 id=éœ€è¦è§£å†³çš„é—®é¢˜>éœ€è¦è§£å†³çš„é—®é¢˜<a hidden class=anchor aria-hidden=true href=#éœ€è¦è§£å†³çš„é—®é¢˜>#</a></h3><ol><li>é”çš„è¯¯è§£é™¤</li><li>ä¸šåŠ¡æ‰§è¡Œè¶…æ—¶å¯¼è‡´å¹¶å‘</li><li>é‡è¯•æœºåˆ¶</li><li><code>GET</code>å’Œ<code>DEL</code>éåŸå­æ€§</li></ol><h3 id=ä»£ç >ä»£ç <a hidden class=anchor aria-hidden=true href=#ä»£ç >#</a></h3><p>ç›®å½•ç»“æ„:</p><pre tabindex=0><code>â”‚  main.go
â”‚
â””â”€demo
        lock.go
</code></pre><p><code>lock.go</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>demo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/go-redis/redis/v8&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é‡è¯•æ¬¡æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>retryTimes</span> = <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é‡è¯•é¢‘ç‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>retryInterval</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>rdb</span> = <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Addr</span>:     <span style=color:#e6db74>&#34;localhost:6379&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Password</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#75715e>// no password set
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>DB</span>:       <span style=color:#ae81ff>0</span>,  <span style=color:#75715e>// use default DB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é”çš„é»˜è®¤è¿‡æœŸæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>expiration</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¨¡æ‹Ÿåˆ†å¸ƒå¼ä¸šåŠ¡åŠ é”åœºæ™¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MockTest</span>(<span style=color:#a6e22e>tag</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> = <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// åœæ­¢goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// éšæœºvalue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lockV</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getRandValue</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lockK</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;EXAMPLE_LOCK&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// é»˜è®¤è¿‡æœŸæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>expiration</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>tag</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;å°è¯•åŠ é”&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>set</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>SetNX</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>lockK</span>, <span style=color:#a6e22e>lockV</span>, <span style=color:#a6e22e>expiration</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// åŠ é”å¤±è´¥,é‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>set</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>retry</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>rdb</span>, <span style=color:#a6e22e>lockK</span>, <span style=color:#a6e22e>lockV</span>, <span style=color:#a6e22e>expiration</span>, <span style=color:#a6e22e>tag</span>) <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>tag</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; server unavailable, try again later&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>tag</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;æˆåŠŸåŠ é”&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// åŠ é”æˆåŠŸ,æ–°å¢å®ˆæŠ¤çº¿ç¨‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>watchDog</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>rdb</span>, <span style=color:#a6e22e>lockK</span>, <span style=color:#a6e22e>expiration</span>, <span style=color:#a6e22e>tag</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¤„ç†ä¸šåŠ¡(é€šè¿‡éšæœºæ—¶é—´å»¶è¿Ÿæ¨¡æ‹Ÿ)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>tag</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;ç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ...&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>getRandDuration</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ä¸šåŠ¡å¤„ç†å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>delByKeyWhenValueEquals</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>rdb</span>, <span style=color:#a6e22e>lockK</span>, <span style=color:#a6e22e>lockV</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>tag</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;é‡Šæ”¾ç»“æœ:&#34;</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>delByKeyWhenValueEquals</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>rdb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lua</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-- å¦‚æœå½“å‰å€¼ä¸é”å€¼ä¸€è‡´,åˆ é™¤key
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if redis.call(&#39;GET&#39;, KEYS[1]) == ARGV[1] then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	return redis.call(&#39;DEL&#39;, KEYS[1])
</span></span></span><span style=display:flex><span><span style=color:#e6db74>else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	return 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>end
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>scriptKeys</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>key</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>Eval</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>lua</span>, <span style=color:#a6e22e>scriptKeys</span>, <span style=color:#a6e22e>value</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>==</span> int64(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç”Ÿæˆéšæœºæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getRandDuration</span>() <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Seed</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UnixNano</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>min</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>max</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>max</span><span style=color:#f92672>-</span><span style=color:#a6e22e>min</span>)<span style=color:#f92672>+</span><span style=color:#a6e22e>min</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç”Ÿæˆéšæœºå€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getRandValue</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Seed</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UnixNano</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Int</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å®ˆæŠ¤çº¿ç¨‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>watchDog</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>rdb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>expiration</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>tag</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä¸šåŠ¡å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%sä»»åŠ¡å®Œæˆ,å…³é—­%sçš„è‡ªåŠ¨ç»­æœŸ\n&#34;</span>, <span style=color:#a6e22e>tag</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ä¸šåŠ¡æœªå®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>			<span style=color:#75715e>// è‡ªåŠ¨ç»­æœŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>PExpire</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>expiration</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ç»§ç»­ç­‰å¾…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>expiration</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>retry</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>rdb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>expiration</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>tag</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>retryTimes</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#a6e22e>tag</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;ç¬¬%dæ¬¡å°è¯•åŠ é”ä¸­...\n&#34;</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>set</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rdb</span>.<span style=color:#a6e22e>SetNX</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>expiration</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>set</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>retryInterval</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=æµç¨‹è¯´æ˜>æµç¨‹è¯´æ˜<a hidden class=anchor aria-hidden=true href=#æµç¨‹è¯´æ˜>#</a></h3><blockquote><p>å‡è®¾<code>MockTest</code>æ–¹æ³•å°±æ˜¯ä¸šåŠ¡å¤„ç†æ–¹æ³•</p></blockquote><ol><li>åˆå§‹åŒ–<code>context</code>ç”¨äºæ§åˆ¶å®ˆæŠ¤çº¿ç¨‹çš„é€€å‡º</li><li>è®¾ç½®éšæœºå€¼å°è¯•åŠ é”(éšæœºå€¼åœ¨é‡Šæ”¾é”æ—¶å¯é¿å…è¯¯é‡Šæ”¾)</li><li>å¦‚æœåŠ é”ä¸æˆåŠŸ,å°è¯•é‡è¯•,é‡è¯•æœºåˆ¶æ ¹æ®ä¸šåŠ¡è€Œå®š,é‡è¯•å¤±è´¥å¤„ç†æ ¹æ®ä¸šåŠ¡è€Œå®š</li><li>æˆåŠŸåŠ é”åå¼€å¯ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹(<code>watchDog</code>),ç”¨äºæŒç»­åˆ·æ–°é”çš„è¿‡æœŸæ—¶é—´,ä¿è¯åœ¨ä¸šåŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é”ä¸ä¼šè¿‡æœŸ</li><li>æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†éšæœºè€—æ—¶</li><li>ä¸šåŠ¡å¤„ç†å®Œæˆåé‡Šæ”¾é”(<code>lua</code>å¤„ç†ä¿è¯åŸå­æ€§,å¹¶å¯¹æ¯”<code>value</code>é¿å…è¯¯é‡Šæ”¾)</li><li>é€šè¿‡<code>cancel</code>å…³é—­å®ˆæŠ¤çº¿ç¨‹(<code>watchDog</code>),é¿å…æ­»é”</li></ol><h3 id=åº”å¯¹åœºæ™¯>åº”å¯¹åœºæ™¯<a hidden class=anchor aria-hidden=true href=#åº”å¯¹åœºæ™¯>#</a></h3><ol><li>çº¿ç¨‹è·å–åˆ°é”åå¼‚å¸¸ç»ˆæ­¢,é”ä¼šåœ¨<code>expire</code>åˆ°æœŸåè‡ªåŠ¨é‡Šæ”¾</li><li>çº¿ç¨‹æ‰§è¡Œæ—¶é—´è¶…å‡ºé”çš„é»˜è®¤<code>expire</code>,é€šè¿‡<code>watchDog</code>è‡ªåŠ¨ç»­æœŸ,é¿å…è¯¥æƒ…å†µå‘ç”Ÿ</li></ol><h3 id=æµ‹è¯•>æµ‹è¯•<a hidden class=anchor aria-hidden=true href=#æµ‹è¯•>#</a></h3><p><code>main.go</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;play/demo&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>demo</span>.<span style=color:#a6e22e>MockTest</span>(<span style=color:#e6db74>&#34;A&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>demo</span>.<span style=color:#a6e22e>MockTest</span>(<span style=color:#e6db74>&#34;B&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>demo</span>.<span style=color:#a6e22e>MockTest</span>(<span style=color:#e6db74>&#34;C&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>demo</span>.<span style=color:#a6e22e>MockTest</span>(<span style=color:#e6db74>&#34;D&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>demo</span>.<span style=color:#a6e22e>MockTest</span>(<span style=color:#e6db74>&#34;E&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç”¨äºæµ‹è¯•goroutineæ¥æ”¶åˆ°ctx.Done()ä¿¡å·åçš„æ‰“å°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç»“æœ:</p><pre tabindex=0><code>$ go run main.go
Aå°è¯•åŠ é”
Då°è¯•åŠ é”
Eå°è¯•åŠ é”
Bå°è¯•åŠ é”
Cå°è¯•åŠ é”
DæˆåŠŸåŠ é”
Dç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ...
Bç¬¬1æ¬¡å°è¯•åŠ é”ä¸­...
Eç¬¬1æ¬¡å°è¯•åŠ é”ä¸­...
Aç¬¬1æ¬¡å°è¯•åŠ é”ä¸­...
Cç¬¬1æ¬¡å°è¯•åŠ é”ä¸­...
Bç¬¬2æ¬¡å°è¯•åŠ é”ä¸­...
Dé‡Šæ”¾ç»“æœ: true
BæˆåŠŸåŠ é”
Eç¬¬2æ¬¡å°è¯•åŠ é”ä¸­...
Bç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ...
Cç¬¬2æ¬¡å°è¯•åŠ é”ä¸­...
Aç¬¬2æ¬¡å°è¯•åŠ é”ä¸­...
Dä»»åŠ¡å®Œæˆ,å…³é—­EXAMPLE_LOCKçš„è‡ªåŠ¨ç»­æœŸ
Aç¬¬3æ¬¡å°è¯•åŠ é”ä¸­...
Cç¬¬3æ¬¡å°è¯•åŠ é”ä¸­...
Eç¬¬3æ¬¡å°è¯•åŠ é”ä¸­...
Bé‡Šæ”¾ç»“æœ: true
AæˆåŠŸåŠ é”
Aç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ...
Bä»»åŠ¡å®Œæˆ,å…³é—­EXAMPLE_LOCKçš„è‡ªåŠ¨ç»­æœŸ
Eç¬¬4æ¬¡å°è¯•åŠ é”ä¸­...
Cç¬¬4æ¬¡å°è¯•åŠ é”ä¸­...
Aé‡Šæ”¾ç»“æœ: true
Aä»»åŠ¡å®Œæˆ,å…³é—­EXAMPLE_LOCKçš„è‡ªåŠ¨ç»­æœŸ
Cç¬¬5æ¬¡å°è¯•åŠ é”ä¸­...
Eç¬¬5æ¬¡å°è¯•åŠ é”ä¸­...
CæˆåŠŸåŠ é”
Cç­‰å¾…ä¸šåŠ¡å¤„ç†å®Œæˆ...
E server unavailable, try again later
Cé‡Šæ”¾ç»“æœ: true
Cä»»åŠ¡å®Œæˆ,å…³é—­EXAMPLE_LOCKçš„è‡ªåŠ¨ç»­æœŸ
</code></pre><p>å·æ‡’å°±æ²¡å†™å•å…ƒæµ‹è¯•äº†ğŸ¤¦â€</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.88886688.xyz/tags/golang/>golang</a></li><li><a href=https://blog.88886688.xyz/tags/redis/>redis</a></li></ul><nav class=paginav><a class=prev href=https://blog.88886688.xyz/posts/2021-05-03-golang+redis%E5%88%86%E5%B8%83%E5%BC%8F%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81/><span class=title>Â« Prev</span><br><span>Golang+Redisåˆ†å¸ƒå¼å¯é‡å…¥é”</span></a>
<a class=next href=https://blog.88886688.xyz/posts/2020-08-28-laravel%E5%88%87%E6%8D%A2%E5%88%B0swoole%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/><span class=title>Next Â»</span><br><span>laravelåˆ‡æ¢åˆ°swooleé—®é¢˜æ€»ç»“</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2017-2023 <a href=https://blog.88886688.xyz/>Lester's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><br><span>Email: <a href=mailto:lestat9527@gmail.com>lestat9527@gmail.com</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
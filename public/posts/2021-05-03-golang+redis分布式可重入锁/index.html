<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Golang&#43;Redis分布式可重入锁 | Lester&#39;s Blog</title>
<meta name="keywords" content="golang, redis">
<meta name="description" content="自动重试,自动续期,可重入">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/2021-05-03-golang&#43;redis%E5%88%86%E5%B8%83%E5%BC%8F%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/2021-05-03-golang&#43;redis%E5%88%86%E5%B8%83%E5%BC%8F%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Lester&#39;s Blog (Alt + H)">Lester&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags" title="Tags/分类">
                    <span>Tags/分类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/raspberrypi3b-post" title="Pi3B/树莓派3B">
                    <span>Pi3B/树莓派3B</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about" title="About/关于">
                    <span>About/关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Golang&#43;Redis分布式可重入锁
    </h1>
    <div class="post-description">
      自动重试,自动续期,可重入
    </div>
    <div class="post-meta"><span title='2021-05-03 14:57:51.923 +0000 UTC'>May 3, 2021</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;852 words

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul><ul>
                <li>
                    <a href="#%e6%a6%82%e5%bf%b5" aria-label="概念">概念</a></li>
                <li>
                    <a href="#%e4%b8%aa%e4%ba%ba%e8%a7%82%e7%82%b9" aria-label="个人观点">个人观点</a></li>
                <li>
                    <a href="#%e5%8a%9f%e8%83%bd" aria-label="功能">功能</a></li>
                <li>
                    <a href="#hash%e9%94%81%e7%9a%84%e7%bb%93%e6%9e%84" aria-label="hash锁的结构">hash锁的结构</a></li>
                <li>
                    <a href="#%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b" aria-label="基本流程">基本流程</a></li></ul>
                    
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0" aria-label="代码实现">代码实现</a><ul>
                        
                <li>
                    <a href="#%e6%b5%8b%e8%af%95" aria-label="测试">测试</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="概念">概念<a hidden class="anchor" aria-hidden="true" href="#概念">#</a></h3>
<blockquote>
<p><a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6">计算机科学</a>中，<strong>可重入互斥锁</strong>（英語：reentrant mutex）是<a href="https://zh.wikipedia.org/wiki/%E4%BA%92%E6%96%A5%E9%94%81">互斥锁</a>的一种，同一<a href="https://zh.wikipedia.org/wiki/%E7%BA%BF%E7%A8%8B">线程</a>对其多次加锁不会产生<a href="https://zh.wikipedia.org/wiki/%E6%AD%BB%E9%94%81">死锁</a>。可重入互斥锁也称<strong>递归互斥锁</strong>（英語：recursive mutex）或<strong>递归锁</strong>（英語：recursive lock）。</p>
<p>如果对已经上锁的普通互斥锁进行「加锁」操作，其结果要么失败，要么会阻塞至解锁。而如果换作可重入互斥锁，<a href="https://zh.wikipedia.org/wiki/%E5%BD%93%E4%B8%94%E4%BB%85%E5%BD%93">当且仅当</a>尝试加锁的线程就是持有该锁的线程时，类似的加锁操作就会成功。可重入互斥锁一般都会记录被加锁的次数，只有执行相同次数的解锁操作才会真正解锁。</p>
<p>递归互斥锁解决了普通互斥锁<a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E9%87%8D%E5%85%A5">不可重入</a>的问题：如果函数先持有锁，然后执行回调，但回调的内容是调用它自己，就会产生<a href="https://zh.wikipedia.org/wiki/%E6%AD%BB%E9%94%81">死锁</a>。</p>
<p>参考维基百科:<a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E9%87%8D%E5%85%A5%E4%BA%92%E6%96%A5%E9%94%81">可重入互斥锁</a></p>
</blockquote>
<h3 id="个人观点">个人观点<a hidden class="anchor" aria-hidden="true" href="#个人观点">#</a></h3>
<p>在Go中应该很少会有这样的场景，互斥锁从字面上理解，应该不能接收重入，需要重入的场景也不应该考虑互斥锁。个人认为更好的解决方法是从设计的层面避免这种场景的出现。因此，与<a href="/2021-05-02-Golang+redis%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%92%E6%96%A5%E9%94%81">基于redis的互斥锁</a>不同，<strong>这篇文章仅仅是尝试在技术上的实现</strong>，在实际应用中应尽可能避免这样的场景出现</p>
<p><a href="https://groups.google.com/g/golang-nuts/c/XqW1qcuZgKg/m/Ui3nQkeLV80J?pli=1">参考</a></p>
<h3 id="功能">功能<a hidden class="anchor" aria-hidden="true" href="#功能">#</a></h3>
<p>在<a href="/2021-05-02-Golang+redis%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%92%E6%96%A5%E9%94%81">基于redis的互斥锁(自动续期,自动重试)</a>的基础上允许重入</p>
<p>实现的关键功能点:</p>
<ul>
<li>加锁：同一线程多次加锁时可以通过某个标识识别该线程为当前持有锁的线程，并且加锁次数+1</li>
<li>解锁：解锁时加锁次数-1，直到次数为0，则可以解锁(<code>DEL</code>)</li>
</ul>
<h3 id="hash锁的结构">hash锁的结构<a hidden class="anchor" aria-hidden="true" href="#hash锁的结构">#</a></h3>
<table>
<thead>
<tr>
<th>Thread</th>
<th>KEY</th>
<th>FIELD</th>
<th>VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>EXAMPLE_LOCK</td>
<td>304597349587439(线程对应的随机数,标识锁,防止误解锁)</td>
<td>1(当前线程已加锁次数)</td>
</tr>
</tbody>
</table>
<h3 id="基本流程">基本流程<a hidden class="anchor" aria-hidden="true" href="#基本流程">#</a></h3>
<p>在不可重入锁的实现里，只需要关心锁的互斥，误解除和自动续期，因此可以直接使用<code>string</code>类型配合<code>SETNX</code>,<code>PEXPIRE</code>,<code>DEL</code>完成加锁，解锁和续期</p>
<p>但可重入锁需要锁可以记录当前线程的标识和当前线程已加锁次数，就需要用<code>redis</code>的<code>hash</code>代替<code>string</code>。因为结构发生了变化，所以在加锁，解锁流程上也会有相应改变</p>
<table>
<thead>
<tr>
<th>Time</th>
<th>ThreadA</th>
<th>ThreadB</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1</td>
<td>尝试加锁</td>
<td>尝试加锁</td>
</tr>
<tr>
<td>T2</td>
<td>加锁成功(key:EXAMPLE_LOCK,field:304597349587439,value:1)</td>
<td>加锁失败</td>
</tr>
<tr>
<td>T3</td>
<td>执行当前方法业务代码</td>
<td>尝试重试加锁并等待ThreadA解锁(根据配置间隔和最大重试次数)</td>
</tr>
<tr>
<td>T4</td>
<td>执行另一个方法业务代码，也可能是递归调用，并再次尝试加锁</td>
<td></td>
</tr>
<tr>
<td>T5</td>
<td>加锁成功(key:EXAMPLE_LOCK,field:304597349587439,value:2)</td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td>执行新的调用方法内的业务代码,直到完成所有嵌套调用</td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td>从最里层调用开始解锁,(key:EXAMPLE_LOCK,field:304597349587439,value:1)</td>
<td></td>
</tr>
<tr>
<td>T8</td>
<td>返回到最外层第一次加锁的位置,解锁(key:EXAMPLE_LOCK,field:304597349587439,value:0)</td>
<td></td>
</tr>
<tr>
<td>T9</td>
<td>如果当前已加锁次数为0，释放锁</td>
<td></td>
</tr>
<tr>
<td>T10</td>
<td></td>
<td>加锁成功</td>
</tr>
</tbody>
</table>
<p>FF
加锁:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- KEYS[1]:锁对应的key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ARGV[1]:锁的expire</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ARGV[2]:锁对应的计数器field(随机值,防止误解锁),记录当前线程已加锁的次数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 判断锁是否空闲</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (redis.call(<span style="color:#e6db74">&#39;EXISTS&#39;</span>, KEYS[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 线程首次加锁(锁的初始化,值和过期时间)</span>
</span></span><span style="display:flex;"><span>    redis.call(<span style="color:#e6db74">&#39;HINCRBY&#39;</span>, KEYS[<span style="color:#ae81ff">1</span>], ARGV[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    redis.call(<span style="color:#e6db74">&#39;PEXPIRE&#39;</span>, KEYS[<span style="color:#ae81ff">1</span>], ARGV[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 判断当前线程是否持有锁(锁被某个线程持有,通常是程序第N次(N&gt;1)在线程内调用时会执行到此处)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (redis.call(<span style="color:#e6db74">&#39;HEXISTS&#39;</span>, KEYS[<span style="color:#ae81ff">1</span>], ARGV[<span style="color:#ae81ff">2</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 调用次数递增</span>
</span></span><span style="display:flex;"><span>    redis.call(<span style="color:#e6db74">&#39;HINCRBY&#39;</span>, KEYS[<span style="color:#ae81ff">1</span>], ARGV[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 不处理续期,通过守护线程续期</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 锁被其他线程占用,加锁失败</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p>解锁:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- KEYS[1]:锁对应的key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- ARGV[1]:锁对应的计数器field(随机值,防止误解锁),记录当前线程已加锁的次数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 判断 hash set 是否存在</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (redis.call(<span style="color:#e6db74">&#39;HEXISTS&#39;</span>, KEYS[<span style="color:#ae81ff">1</span>], ARGV[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- err = redis.Nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 计算当前已加锁次数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> counter <span style="color:#f92672">=</span> redis.call(<span style="color:#e6db74">&#39;HINCRBY&#39;</span>, KEYS[<span style="color:#ae81ff">1</span>], ARGV[<span style="color:#ae81ff">1</span>], <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (counter <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- 同一线程内部多次调用完成后尝试释放锁会进入此if分支</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- 同一线程最外层(第一次)调用完成后尝试释放锁会进入此if分支</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">-- &lt;=0代表内层嵌套调用已全部完成，可以解锁</span>
</span></span><span style="display:flex;"><span>    redis.call(<span style="color:#e6db74">&#39;DEL&#39;</span>, KEYS[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- err = redis.Nil</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>;
</span></span></code></pre></div><p><a href="https://segmentfault.com/a/1190000022931307">参考</a></p>
<h2 id="代码实现">代码实现<a hidden class="anchor" aria-hidden="true" href="#代码实现">#</a></h2>
<blockquote>
<p>以下代码仅实现可重入加锁，自动续期，自动重试功能和本地测试，并不考虑封装或复用！</p>
</blockquote>
<p>目录结构:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── main.go
</span></span><span style="display:flex;"><span>└── reentrant_mutex
</span></span><span style="display:flex;"><span>    └── lock.go
</span></span></code></pre></div><p><code>lock.go</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">reentrant_mutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">KEY</span> = <span style="color:#e6db74">&#34;EXAMPLE_LOCK&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Lock 用于测试的锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Lock</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// redis连接池
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Rdb</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// hash锁key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Key</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// hash锁field(随机数,实时唯一)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Field</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁有效期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Expiration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于测试的初始递归层数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RecursionLevel</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于测试的最大递归层数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxRecursionLevel</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于测试的任务最小执行时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Min</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于测试的任务最大执行时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Max</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 加锁失败的重试间隔
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RetryInterval</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 加锁失败的重试次数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RetryTimes</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 继承*sync.Once的特性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Once</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于测试打印的线程标签
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Tag</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;initializing rand seed for rand testing...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 生成一个随机标签
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getRandTag</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">runes</span> = []rune(<span style="color:#e6db74">&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tag</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">rune</span>, <span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tag</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tag</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">runes</span>[<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(len(<span style="color:#a6e22e">runes</span>))]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> string(<span style="color:#a6e22e">tag</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewLock 初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewLock</span>(<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Lock</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Lock</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Rdb</span>:               <span style="color:#a6e22e">rdb</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Key</span>:               <span style="color:#a6e22e">KEY</span>, <span style="color:#75715e">// 固定值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Field</span>:             <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Int</span>(),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Expiration</span>:        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">200</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RecursionLevel</span>:    <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">MaxRecursionLevel</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Min</span>:               <span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Max</span>:               <span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RetryInterval</span>:     <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RetryTimes</span>:        <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Once</span>:              new(<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Once</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Tag</span>:               <span style="color:#a6e22e">getRandTag</span>(<span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">l</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MockBusiness 模拟分布式业务加锁场景
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Lock</span>) <span style="color:#a6e22e">MockBusiness</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s的第%d次调用,Field:%d\n&#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">RecursionLevel</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Field</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化仅用于当前调用的ctx,避免在重入调用完成后执行cancel()导致的上层调用出现context canceled错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 延迟停止守护线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">set</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">lock</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 加锁失败:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 加锁失败,重试
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">set</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">retry</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 重试加锁失败:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 重试达到最大次数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; server unavailable, try again later&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;成功加锁&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 加锁成功,通过守护线程自动续期(此处可以异步执行,即使自动续期还没来得及执行业务就已经完成,也不会影响流程)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">watchDog</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;等待业务处理完成...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 模拟处理业务(通过随机时间模拟业务延迟)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Max</span><span style="color:#f92672">-</span><span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Min</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Min</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 模拟重入调用(测试锁的可重入)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">RecursionLevel</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">MaxRecursionLevel</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">RecursionLevel</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">MockBusiness</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 业务处理完成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 释放锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">val</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">unlock</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;锁释放失败:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 递归调用中的结果都是false,因为lua脚本中的if分支counter&gt;0,没有释放
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;释放结果:&#34;</span>, <span style="color:#a6e22e">val</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 守护线程(通过sync.Once.Do确保仅在线程第一次调用时执行自动续期)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Lock</span>) <span style="color:#a6e22e">watchDog</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Once</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;打开了%s的守护线程\n&#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 业务完成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s任务完成,关闭%s的自动续期\n&#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 业务未完成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 自动续期
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Rdb</span>.<span style="color:#a6e22e">PExpire</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Expiration</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 继续等待
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Expiration</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 加锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Lock</span>) <span style="color:#a6e22e">lock</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">res</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lua</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- KEYS[1]:锁对应的key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- ARGV[1]:锁的expire
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- ARGV[2]:锁对应的计数器field(随机值,防止误解锁),记录当前线程已加锁的次数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- 判断锁是否空闲
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if (redis.call(&#39;EXISTS&#39;, KEYS[1]) == 0) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    -- 线程首次加锁(锁的初始化,值和过期时间)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    redis.call(&#39;HINCRBY&#39;, KEYS[1], ARGV[2], 1);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    redis.call(&#39;PEXPIRE&#39;, KEYS[1], ARGV[1]);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- 判断当前线程是否持有锁(锁被某个线程持有,通常是程序第N次(N&gt;1)在线程内调用时会执行到此处)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if (redis.call(&#39;HEXISTS&#39;, KEYS[1], ARGV[2]) == 1) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    -- 调用次数递增
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    redis.call(&#39;HINCRBY&#39;, KEYS[1], ARGV[2], 1);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    -- 不处理续期,通过守护线程续期
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- 锁被其他线程占用,加锁失败
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">return 0;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scriptKeys</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Key</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">val</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Rdb</span>.<span style="color:#a6e22e">Eval</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">lua</span>, <span style="color:#a6e22e">scriptKeys</span>, int(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Expiration</span>), <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Field</span>).<span style="color:#a6e22e">Result</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">res</span> = <span style="color:#a6e22e">val</span> <span style="color:#f92672">==</span> int64(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 解锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Lock</span>) <span style="color:#a6e22e">unlock</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">res</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lua</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- KEYS[1]:锁对应的key
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- ARGV[1]:锁对应的计数器field(随机值,防止误解锁),记录当前线程已加锁的次数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- 判断 hash set 是否存在
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if (redis.call(&#39;HEXISTS&#39;, KEYS[1], ARGV[1]) == 0) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    -- err = redis.Nil
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return nil;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- 计算当前可重入次数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local counter = redis.call(&#39;HINCRBY&#39;, KEYS[1], ARGV[1], -1);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">if (counter &gt; 0) then
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- 同一线程内部多次调用完成后尝试释放锁会进入此if分支
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return 0;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">else
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- 同一线程最外层(第一次)调用完成后尝试释放锁会进入此if分支
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- 小于等于 0 代表内层嵌套调用已全部完成，可以解锁
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    redis.call(&#39;DEL&#39;, KEYS[1]);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return 1;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">end;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-- err = redis.Nil
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">return nil;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scriptKeys</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Key</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">val</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Rdb</span>.<span style="color:#a6e22e">Eval</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">lua</span>, <span style="color:#a6e22e">scriptKeys</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Field</span>).<span style="color:#a6e22e">Result</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">res</span> = <span style="color:#a6e22e">val</span> <span style="color:#f92672">==</span> int64(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 重试
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Lock</span>) <span style="color:#a6e22e">retry</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">res</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">RetryTimes</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Tag</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;第%d次重试加锁中,Field:%d\n&#34;</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Field</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">lock</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">RetryInterval</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>main.go</code>(测试加锁):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;example/reentrant_mutex&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/go-redis/redis/v8&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化连接池
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Options</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Addr</span>:     <span style="color:#e6db74">&#34;localhost:6379&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Password</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e">// no password set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">DB</span>:       <span style="color:#ae81ff">0</span>,  <span style="color:#75715e">// use default DB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">max</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">max</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">reentrant_mutex</span>.<span style="color:#a6e22e">NewLock</span>(<span style="color:#a6e22e">rdb</span>).<span style="color:#a6e22e">MockBusiness</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">max</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="测试">测试<a hidden class="anchor" aria-hidden="true" href="#测试">#</a></h3>
<p>测试环境:</p>
<p>Redis:<code>Redis server v=6.2.3</code></p>
<p>Go:<code>go version go1.14.6 darwin/amd64</code></p>
<p>测试配置:</p>
<ul>
<li>
<p>每个线程可重入次数1次(总加锁2次)</p>
</li>
<li>
<p>每个线程开启1个自动续期的守护线程(sync.Once.Do确保仅调用1次)</p>
</li>
<li>
<p>每个模拟业务延迟时间用50~100ms的范围随机生成</p>
</li>
<li>
<p><code>hash</code>锁的<code>field</code>通过线程初始化时生成,执行过程中<code>field</code>不变,<code>field</code>是判断一个锁是否属于当前线程唯一标准</p>
</li>
<li>
<p>加锁失败后重试次数为5，重试间隔为50ms</p>
</li>
<li>
<p>通过随机生成的<code>Tag</code>来标识线程以及打印流程</p>
</li>
<li>
<p>互斥锁的<code>KEY</code>为<code>EXAMPLE_LOCK</code></p>
</li>
</ul>
<p>测试结果:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go run main.go                                                                                                                                          
</span></span><span style="display:flex;"><span>initializing rand seed <span style="color:#66d9ef">for</span> rand testing...
</span></span><span style="display:flex;"><span>oH的第1次调用,Field:3502865528850892548
</span></span><span style="display:flex;"><span>8U的第1次调用,Field:4832526999886838931
</span></span><span style="display:flex;"><span>oH成功加锁
</span></span><span style="display:flex;"><span>oH等待业务处理完成...
</span></span><span style="display:flex;"><span>打开了oH的守护线程
</span></span><span style="display:flex;"><span>8U第1次重试加锁中,Field:4832526999886838931
</span></span><span style="display:flex;"><span>8U第2次重试加锁中,Field:4832526999886838931
</span></span><span style="display:flex;"><span>oH的第2次调用,Field:3502865528850892548
</span></span><span style="display:flex;"><span>oH成功加锁
</span></span><span style="display:flex;"><span>oH等待业务处理完成...
</span></span><span style="display:flex;"><span>8U第3次重试加锁中,Field:4832526999886838931
</span></span><span style="display:flex;"><span>8U第4次重试加锁中,Field:4832526999886838931
</span></span><span style="display:flex;"><span>oH释放结果: false
</span></span><span style="display:flex;"><span>oH释放结果: true
</span></span><span style="display:flex;"><span>oH任务完成,关闭EXAMPLE_LOCK的自动续期
</span></span><span style="display:flex;"><span>8U第5次重试加锁中,Field:4832526999886838931
</span></span><span style="display:flex;"><span>8U成功加锁
</span></span><span style="display:flex;"><span>8U等待业务处理完成...
</span></span><span style="display:flex;"><span>打开了8U的守护线程
</span></span><span style="display:flex;"><span>8U的第2次调用,Field:4832526999886838931
</span></span><span style="display:flex;"><span>8U成功加锁
</span></span><span style="display:flex;"><span>8U等待业务处理完成...
</span></span><span style="display:flex;"><span>8U释放结果: false
</span></span><span style="display:flex;"><span>8U释放结果: true
</span></span><span style="display:flex;"><span>8U任务完成,关闭EXAMPLE_LOCK的自动续期
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/golang/">Golang</a></li>
      <li><a href="http://localhost:1313/tags/redis/">Redis</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/2021-07-18-%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%9A%84%E7%BC%96%E7%A8%8B%E4%B9%A0%E6%83%AF/">
    <span class="title">« Prev</span>
    <br>
    <span>一些好的编程习惯</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/2021-05-02-golang&#43;redis%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%92%E6%96%A5%E9%94%81/">
    <span class="title">Next »</span>
    <br>
    <span>Golang&#43;Redis分布式互斥锁</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Lester&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

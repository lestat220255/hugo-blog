<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>mysql实现主从复制 | Lester's Blog</title><meta name=keywords content="mysql"><meta name=description content="1主2从配置"><meta name=author content><link rel=canonical href=https://blog.88886688.xyz/posts/2019-02-19-mysql%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/><link crossorigin=anonymous href=/assets/css/stylesheet.84a638ec294a2a547ea8ea3f2466d240b38b987cbbb815b534c0442ed8d517d7.css integrity="sha256-hKY47ClKKlR+qOo/JGbSQLOLmHy7uBW1NMBELtjVF9c=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.88886688.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.88886688.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.88886688.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.88886688.xyz/apple-touch-icon.png><link rel=mask-icon href=https://blog.88886688.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="mysql实现主从复制"><meta property="og:description" content="1主2从配置"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.88886688.xyz/posts/2019-02-19-mysql%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-02-19T22:39:11+00:00"><meta property="article:modified_time" content="2019-02-19T22:39:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="mysql实现主从复制"><meta name=twitter:description content="1主2从配置"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.88886688.xyz/posts/"},{"@type":"ListItem","position":2,"name":"mysql实现主从复制","item":"https://blog.88886688.xyz/posts/2019-02-19-mysql%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"mysql实现主从复制","name":"mysql实现主从复制","description":"1主2从配置","keywords":["mysql"],"articleBody":"基本流程 docker-compose.yml文件配置 #数据库-主库 mysql57: image: ${MYSQL_IMAGE} environment: - MYSQL_ROOT_PASSWORD=${MYSQL_MASTER_ROOT_PASSWORD} #- MYSQL_USER=user #- MYSQL_PASSWORD=password volumes: #配置文件 - ${MYSQL_MASTER_CONF}:/etc/mysql/my.cnf:ro #数据目录 - ${MYSQL_MASTER_DATA}:/var/lib/mysql/:rw #查询日志文件 #- ./logs/mysql/query_mysql.log:/var/logs/mysql/query.mysql.log:rw #慢查询日志文件 #- ./logs/mysql/slow_mysql.log:/var/logs/mysql/slow.mysql.log:rw restart: always ports: - \"${MYSQL_MASTER_PORT}:3306\" container_name: mysql57 #从库01 mysql57-slave01: depends_on: - mysql57 image: ${MYSQL_IMAGE} environment: - MYSQL_ROOT_PASSWORD=${MYSQL_SLAVE_01_ROOT_PASSWORD} - MASTER_HOST=mysql57 #- MYSQL_USER=user #- MYSQL_PASSWORD=password volumes: #配置文件 - ${MYSQL_SLAVE_01_CONF}:/etc/mysql/my.cnf:ro #数据目录 - ${MYSQL_SLAVE_01_DATA}:/var/lib/mysql/:rw #查询日志文件 #- ./logs/mysql/query_mysql.log:/var/logs/mysql/query.mysql.log:rw #慢查询日志文件 #- ./logs/mysql/slow_mysql.log:/var/logs/mysql/slow.mysql.log:rw restart: always ports: - \"${MYSQL_SLAVE_01_PORT}:3306\" container_name: mysql57-slave01 #从库02 mysql57-slave02: depends_on: - mysql57 image: ${MYSQL_IMAGE} environment: - MYSQL_ROOT_PASSWORD=${MYSQL_SLAVE_02_ROOT_PASSWORD} - MASTER_HOST=mysql57 #- MYSQL_USER=user #- MYSQL_PASSWORD=password volumes: #配置文件 - ${MYSQL_SLAVE_02_CONF}:/etc/mysql/my.cnf:ro #数据目录 - ${MYSQL_SLAVE_02_DATA}:/var/lib/mysql/:rw #查询日志文件 #- ./logs/mysql/query_mysql.log:/var/logs/mysql/query.mysql.log:rw #慢查询日志文件 #- ./logs/mysql/slow_mysql.log:/var/logs/mysql/slow.mysql.log:rw restart: always ports: - \"${MYSQL_SLAVE_02_PORT}:3306\" container_name: mysql57-slave02 master配置 my.cnf文件加入:\n## 设置server_id，一般设置为IP，同一局域网内注意要唯一 server_id=id1 ## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步） binlog-ignore-db=mysql ## 开启二进制日志功能，可以随便取，最好有含义（关键就是这里了） log-bin=community-mysql-bin ## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存 binlog_cache_size=1M ## 主从复制的格式（mixed,statement,row，默认格式是statement） binlog_format=mixed ## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。 expire_logs_days=7 ## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。 ## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致 slave_skip_errors=1062 重启master service mysql restart\n查看master状态 mysql\u003e show master status \\G; 得到类似:\n*************************** 1. row *************************** File: community-mysql-bin.000003 Position: 50759 Binlog_Do_DB: Binlog_Ignore_DB: mysql Executed_Gtid_Set: 1 row in set (0.00 sec) master库创建slave用户 CREATE USER 'slave01'@'%' IDENTIFIED BY 'password'; GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave01'@'%'; CREATE USER 'slave02'@'%' IDENTIFIED BY 'password'; GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave02'@'%'; slave配置 my.cnf文件加入:\n## 设置server_id,唯一 server_id=id2 ## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步） binlog-ignore-db=mysql ## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用 log-bin=community-mysql-slave-bin ## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存 binlog_cache_size=1M ## 主从复制的格式（mixed,statement,row，默认格式是statement） binlog_format=mixed ## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。 expire_logs_days=7 ## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。 ## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致 slave_skip_errors=1062 ## relay_log配置中继日志 relay_log=community-mysql-relay-bin ## log_slave_updates表示slave将复制事件写进自己的二进制日志 log_slave_updates=1 ## 防止改变数据(除了特殊的线程) read_only=1 重启slave service mysql restart\n查看slave状态 show slave status \\G;\n连接master服务器 -- 两个从库分别配置主库 change master to master_host='mysql57',master_user='slave01',master_password='password',master_port=port,master_log_file='master库的master_log_file文件:上面通过`show master status`得到的File字段',master_log_pos=0; change master to master_host='mysql57',master_user='slave02',master_password='password',master_port=port,master_log_file='master库的master_log_file文件:上面通过`show master status`得到的File字段',master_log_pos=0; -- 开启同步 start slave; -- 查看状态 show slave status \\G; 显示类似内容:\n*************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: mysql57 Master_User: slave Master_Port: 3306 Connect_Retry: 30 Master_Log_File: community-mysql-bin.000003 Read_Master_Log_Pos: 51273 Relay_Log_File: community-mysql-relay-bin.000002 Relay_Log_Pos: 51506 Relay_Master_Log_File: community-mysql-bin.000003 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 51273 Relay_Log_Space: 51723 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0 Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 100 Master_UUID: 9d09b11c-fdeb-11e8-8ac4-0242ac140006 Master_Info_File: /var/lib/mysql/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec) 如果Slave_IO_Running,Slave_SQL_Running不为YES,则排查以上步骤是否正确\n至此配置完成\nlaravel中相关配置 在config/database.php中mysql段配置如下:\n'mysql' =\u003e [ 'read' =\u003e [ 'host' =\u003e env('DB_SLAVE_HOST', '127.0.0.1'), ], 'write' =\u003e [ 'host' =\u003e env('DB_HOST', '127.0.0.1'), ], 'sticky' =\u003e true, 'driver' =\u003e 'mysql', 'database' =\u003e env('DB_DATABASE', ''), 'username' =\u003e env('DB_USERNAME', ''), 'password' =\u003e env('DB_PASSWORD', ''), 'unix_socket' =\u003e env('DB_SOCKET', ''), 'charset' =\u003e 'utf8mb4', 'collation' =\u003e 'utf8mb4_general_ci', 'prefix' =\u003e '', 'strict' =\u003e false, 'engine' =\u003e null, ], 注意 如果是线上操作(持续有数据写入),则需要按照以下步骤：master锁表–\u003emaster备份数据–\u003emaster解锁表 –\u003eslave导入数据–\u003eslave设置主从–\u003e查看主从 如果多个从库需要注意 数据目录auto.cnf中的server-uuid唯一 配置文件my.cnf中的server_id唯一 需要在从库的容器环境变量中添加MASTER_HOST=主节点容器名称来确保容器重启之后自动同步主库binlog 错误修复 如果遇到类似以下错误,可能是由于主从库之间结构不同或其他原因造成的SQL query执行失败\nmysql\u003e SHOW SLAVE STATUS \\G *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: 1.2.3.4 Master_User: slave_user Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.001079 Read_Master_Log_Pos: 269214454 Relay_Log_File: slave-relay.000130 Relay_Log_Pos: 100125935 Relay_Master_Log_File: mysql-bin.001079 Slave_IO_Running: Yes Slave_SQL_Running: No Replicate_Do_DB: mydb Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 1146 Last_Error: Error 'Table 'mydb.taggregate_temp_1212047760' doesn't exist' on query. Default database: 'mydb'. Query: 'UPDATE thread AS thread,taggregate_temp_1212047760 AS aggregate SET thread.views = thread.views + aggregate.views WHERE thread.threadid = aggregate.threadid' Skip_Counter: 0 Exec_Master_Log_Pos: 203015142 Relay_Log_Space: 166325247 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: NULL 1 row in set (0.00 sec) 可以通过以下步骤跳过错误\nmysql\u003e stop slave;-- 停止 mysql\u003e SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1;-- 跳过指定数量的SQL query,此处为1条 mysql\u003e start slave;-- 开启 mysql\u003e show slave status \\G;-- 状态 *************************** 1. row *************************** Slave_IO_State: Waiting for master to send event Master_Host: mysql57 Master_User: slave Master_Port: 3306 Connect_Retry: 30 Master_Log_File: community-mysql-bin.000005 Read_Master_Log_Pos: 2145 Relay_Log_File: community-mysql-relay-bin.000010 Relay_Log_Pos: 330 Relay_Master_Log_File: community-mysql-bin.000005 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 2145 Relay_Log_Space: 2771 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: No Master_SSL_CA_File: Master_SSL_CA_Path: Master_SSL_Cert: Master_SSL_Cipher: Master_SSL_Key: Seconds_Behind_Master: 0 Master_SSL_Verify_Server_Cert: No Last_IO_Errno: 0 Last_IO_Error: Last_SQL_Errno: 0 Last_SQL_Error: Replicate_Ignore_Server_Ids: Master_Server_Id: 100 Master_UUID: c28b993e-368d-11e9-96c4-0242ac120002 Master_Info_File: /var/lib/mysql/master.info SQL_Delay: 0 SQL_Remaining_Delay: NULL Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates Master_Retry_Count: 86400 Master_Bind: Last_IO_Error_Timestamp: Last_SQL_Error_Timestamp: Master_SSL_Crl: Master_SSL_Crlpath: Retrieved_Gtid_Set: Executed_Gtid_Set: Auto_Position: 0 Replicate_Rewrite_DB: Channel_Name: Master_TLS_Version: 1 row in set (0.00 sec) ERROR: No query specified ","wordCount":"684","inLanguage":"en","datePublished":"2019-02-19T22:39:11.923Z","dateModified":"2019-02-19T22:39:11.923Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.88886688.xyz/posts/2019-02-19-mysql%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"},"publisher":{"@type":"Organization","name":"Lester's Blog","logo":{"@type":"ImageObject","url":"https://blog.88886688.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.88886688.xyz/ accesskey=h title="Lester's Blog (Alt + H)">Lester's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.88886688.xyz/ title="Lester's Blog"><span>Home</span></a></li><li><a href=https://blog.88886688.xyz/tags/ title=Tags><span>Tags/分类</span></a></li><li><a href=https://blog.88886688.xyz/about/ title="About Me"><span>About/关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.88886688.xyz/>Home</a>&nbsp;»&nbsp;<a href=https://blog.88886688.xyz/posts/>Posts</a></div><h1 class=post-title>mysql实现主从复制</h1><div class=post-description>1主2从配置</div><div class=post-meta><span title='2019-02-19 22:39:11.923 +0000 UTC'>February 19, 2019</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;684 words</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e6%b5%81%e7%a8%8b aria-label=基本流程>基本流程</a></li><li><a href=#docker-composeyml%e6%96%87%e4%bb%b6%e9%85%8d%e7%bd%ae aria-label=docker-compose.yml文件配置>docker-compose.yml文件配置</a></li><li><a href=#master%e9%85%8d%e7%bd%ae aria-label=master配置>master配置</a></li><li><a href=#%e9%87%8d%e5%90%afmaster aria-label=重启master>重启master</a></li><li><a href=#%e6%9f%a5%e7%9c%8bmaster%e7%8a%b6%e6%80%81 aria-label=查看master状态>查看master状态</a></li><li><a href=#master%e5%ba%93%e5%88%9b%e5%bb%baslave%e7%94%a8%e6%88%b7 aria-label=master库创建slave用户>master库创建slave用户</a></li><li><a href=#slave%e9%85%8d%e7%bd%ae aria-label=slave配置>slave配置</a></li><li><a href=#%e9%87%8d%e5%90%afslave aria-label=重启slave>重启slave</a></li><li><a href=#%e6%9f%a5%e7%9c%8bslave%e7%8a%b6%e6%80%81 aria-label=查看slave状态>查看slave状态</a></li><li><a href=#%e8%bf%9e%e6%8e%a5master%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=连接master服务器>连接master服务器</a></li><li><a href=#laravel%e4%b8%ad%e7%9b%b8%e5%85%b3%e9%85%8d%e7%bd%ae aria-label=laravel中相关配置>laravel中相关配置</a></li><li><a href=#%e6%b3%a8%e6%84%8f aria-label=注意>注意</a></li><li><a href=#%e9%94%99%e8%af%af%e4%bf%ae%e5%a4%8d aria-label=错误修复>错误修复</a></li></ul></div></details></div><div class=post-content><h3 id=基本流程>基本流程<a hidden class=anchor aria-hidden=true href=#基本流程>#</a></h3><p><img loading=lazy src=https://ws1.sinaimg.cn/large/005NqLEEgy1g0bhfrv2wzj30ev091dgy.jpg alt=基本流程></p><h3 id=docker-composeyml文件配置>docker-compose.yml文件配置<a hidden class=anchor aria-hidden=true href=#docker-composeyml文件配置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#75715e>#数据库-主库</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mysql57</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>${MYSQL_IMAGE}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>MYSQL_ROOT_PASSWORD=${MYSQL_MASTER_ROOT_PASSWORD}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#- MYSQL_USER=user</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#- MYSQL_PASSWORD=password</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e>#配置文件</span>
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>${MYSQL_MASTER_CONF}:/etc/mysql/my.cnf:ro</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#数据目录</span>
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>${MYSQL_MASTER_DATA}:/var/lib/mysql/:rw</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#查询日志文件</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#- ./logs/mysql/query_mysql.log:/var/logs/mysql/query.mysql.log:rw</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#慢查询日志文件</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#- ./logs/mysql/slow_mysql.log:/var/logs/mysql/slow.mysql.log:rw</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#34;${MYSQL_MASTER_PORT}:3306&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>mysql57</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#从库01</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mysql57-slave01</span>:
</span></span><span style=display:flex><span>       <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>mysql57</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>image</span>: <span style=color:#ae81ff>${MYSQL_IMAGE}</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>MYSQL_ROOT_PASSWORD=${MYSQL_SLAVE_01_ROOT_PASSWORD}</span>
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>MASTER_HOST=mysql57</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#- MYSQL_USER=user</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#- MYSQL_PASSWORD=password</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>           <span style=color:#75715e>#配置文件</span>
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>${MYSQL_SLAVE_01_CONF}:/etc/mysql/my.cnf:ro</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#数据目录</span>
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>${MYSQL_SLAVE_01_DATA}:/var/lib/mysql/:rw</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#查询日志文件</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#- ./logs/mysql/query_mysql.log:/var/logs/mysql/query.mysql.log:rw</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#慢查询日志文件</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#- ./logs/mysql/slow_mysql.log:/var/logs/mysql/slow.mysql.log:rw</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>           - <span style=color:#e6db74>&#34;${MYSQL_SLAVE_01_PORT}:3306&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>mysql57-slave01</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#从库02</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mysql57-slave02</span>:
</span></span><span style=display:flex><span>       <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>mysql57</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>image</span>: <span style=color:#ae81ff>${MYSQL_IMAGE}</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>MYSQL_ROOT_PASSWORD=${MYSQL_SLAVE_02_ROOT_PASSWORD}</span>
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>MASTER_HOST=mysql57</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#- MYSQL_USER=user</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#- MYSQL_PASSWORD=password</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>           <span style=color:#75715e>#配置文件</span>
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>${MYSQL_SLAVE_02_CONF}:/etc/mysql/my.cnf:ro</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#数据目录</span>
</span></span><span style=display:flex><span>           - <span style=color:#ae81ff>${MYSQL_SLAVE_02_DATA}:/var/lib/mysql/:rw</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#查询日志文件</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#- ./logs/mysql/query_mysql.log:/var/logs/mysql/query.mysql.log:rw</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#慢查询日志文件</span>
</span></span><span style=display:flex><span>           <span style=color:#75715e>#- ./logs/mysql/slow_mysql.log:/var/logs/mysql/slow.mysql.log:rw</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>           - <span style=color:#e6db74>&#34;${MYSQL_SLAVE_02_PORT}:3306&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>mysql57-slave02</span>
</span></span></code></pre></div><h3 id=master配置>master配置<a hidden class=anchor aria-hidden=true href=#master配置>#</a></h3><p>my.cnf文件加入:</p><pre tabindex=0><code class=language-conf data-lang=conf>## 设置server_id，一般设置为IP，同一局域网内注意要唯一
server_id=id1
## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）
binlog-ignore-db=mysql
## 开启二进制日志功能，可以随便取，最好有含义（关键就是这里了）
log-bin=community-mysql-bin
## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存
binlog_cache_size=1M
## 主从复制的格式（mixed,statement,row，默认格式是statement）
binlog_format=mixed
## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。
expire_logs_days=7
## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
slave_skip_errors=1062
</code></pre><h3 id=重启master>重启master<a hidden class=anchor aria-hidden=true href=#重启master>#</a></h3><p><code>service mysql restart</code></p><h3 id=查看master状态>查看master状态<a hidden class=anchor aria-hidden=true href=#查看master状态>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>show</span> master status <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span>;
</span></span></code></pre></div><p>得到类似:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*************************** 1. row ***************************
</span></span><span style=display:flex><span>             File: community-mysql-bin.000003
</span></span><span style=display:flex><span>         Position: <span style=color:#ae81ff>50759</span>
</span></span><span style=display:flex><span>     Binlog_Do_DB:
</span></span><span style=display:flex><span> Binlog_Ignore_DB: mysql
</span></span><span style=display:flex><span>Executed_Gtid_Set:
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><h3 id=master库创建slave用户>master库创建slave用户<a hidden class=anchor aria-hidden=true href=#master库创建slave用户>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>USER</span> <span style=color:#e6db74>&#39;slave01&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED <span style=color:#66d9ef>BY</span> <span style=color:#e6db74>&#39;password&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span style=color:#66d9ef>ON</span> <span style=color:#f92672>*</span>.<span style=color:#f92672>*</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#39;slave01&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>USER</span> <span style=color:#e6db74>&#39;slave02&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED <span style=color:#66d9ef>BY</span> <span style=color:#e6db74>&#39;password&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> REPLICATION SLAVE, REPLICATION CLIENT <span style=color:#66d9ef>ON</span> <span style=color:#f92672>*</span>.<span style=color:#f92672>*</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#39;slave02&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span>;
</span></span></code></pre></div><h3 id=slave配置>slave配置<a hidden class=anchor aria-hidden=true href=#slave配置>#</a></h3><p>my.cnf文件加入:</p><pre tabindex=0><code class=language-conf data-lang=conf>## 设置server_id,唯一
server_id=id2
## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）
binlog-ignore-db=mysql
## 开启二进制日志功能，以备Slave作为其它Slave的Master时使用
log-bin=community-mysql-slave-bin
## 为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存
binlog_cache_size=1M
## 主从复制的格式（mixed,statement,row，默认格式是statement）
binlog_format=mixed
## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。
expire_logs_days=7
## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
slave_skip_errors=1062
## relay_log配置中继日志
relay_log=community-mysql-relay-bin
## log_slave_updates表示slave将复制事件写进自己的二进制日志
log_slave_updates=1
## 防止改变数据(除了特殊的线程)
read_only=1
</code></pre><h3 id=重启slave>重启slave<a hidden class=anchor aria-hidden=true href=#重启slave>#</a></h3><p><code>service mysql restart</code></p><h3 id=查看slave状态>查看slave状态<a hidden class=anchor aria-hidden=true href=#查看slave状态>#</a></h3><p><code>show slave status \G;</code></p><h3 id=连接master服务器>连接master服务器<a hidden class=anchor aria-hidden=true href=#连接master服务器>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 两个从库分别配置主库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>change master <span style=color:#66d9ef>to</span> master_host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;mysql57&#39;</span>,master_user<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;slave01&#39;</span>,master_password<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;password&#39;</span>,master_port<span style=color:#f92672>=</span>port,master_log_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;master库的master_log_file文件:上面通过`show master status`得到的File字段&#39;</span>,master_log_pos<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;  
</span></span><span style=display:flex><span>change master <span style=color:#66d9ef>to</span> master_host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;mysql57&#39;</span>,master_user<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;slave02&#39;</span>,master_password<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;password&#39;</span>,master_port<span style=color:#f92672>=</span>port,master_log_file<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;master库的master_log_file文件:上面通过`show master status`得到的File字段&#39;</span>,master_log_pos<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>-- 开启同步
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>start</span> slave;
</span></span><span style=display:flex><span><span style=color:#75715e>-- 查看状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>show</span> slave status <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span>;
</span></span></code></pre></div><p>显示类似内容:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*************************** 1. row ***************************
</span></span><span style=display:flex><span>               Slave_IO_State: Waiting <span style=color:#66d9ef>for</span> master to send event
</span></span><span style=display:flex><span>                  Master_Host: mysql57
</span></span><span style=display:flex><span>                  Master_User: slave
</span></span><span style=display:flex><span>                  Master_Port: <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>                Connect_Retry: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>              Master_Log_File: community-mysql-bin.000003
</span></span><span style=display:flex><span>          Read_Master_Log_Pos: <span style=color:#ae81ff>51273</span>
</span></span><span style=display:flex><span>               Relay_Log_File: community-mysql-relay-bin.000002
</span></span><span style=display:flex><span>                Relay_Log_Pos: <span style=color:#ae81ff>51506</span>
</span></span><span style=display:flex><span>        Relay_Master_Log_File: community-mysql-bin.000003
</span></span><span style=display:flex><span>             Slave_IO_Running: Yes
</span></span><span style=display:flex><span>            Slave_SQL_Running: Yes
</span></span><span style=display:flex><span>              Replicate_Do_DB:
</span></span><span style=display:flex><span>          Replicate_Ignore_DB:
</span></span><span style=display:flex><span>           Replicate_Do_Table:
</span></span><span style=display:flex><span>       Replicate_Ignore_Table:
</span></span><span style=display:flex><span>      Replicate_Wild_Do_Table:
</span></span><span style=display:flex><span>  Replicate_Wild_Ignore_Table:
</span></span><span style=display:flex><span>                   Last_Errno: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>                   Last_Error:
</span></span><span style=display:flex><span>                 Skip_Counter: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>          Exec_Master_Log_Pos: <span style=color:#ae81ff>51273</span>
</span></span><span style=display:flex><span>              Relay_Log_Space: <span style=color:#ae81ff>51723</span>
</span></span><span style=display:flex><span>              Until_Condition: None
</span></span><span style=display:flex><span>               Until_Log_File:
</span></span><span style=display:flex><span>                Until_Log_Pos: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>           Master_SSL_Allowed: No
</span></span><span style=display:flex><span>           Master_SSL_CA_File:
</span></span><span style=display:flex><span>           Master_SSL_CA_Path:
</span></span><span style=display:flex><span>              Master_SSL_Cert:
</span></span><span style=display:flex><span>            Master_SSL_Cipher:
</span></span><span style=display:flex><span>               Master_SSL_Key:
</span></span><span style=display:flex><span>        Seconds_Behind_Master: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Master_SSL_Verify_Server_Cert: No
</span></span><span style=display:flex><span>                Last_IO_Errno: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>                Last_IO_Error:
</span></span><span style=display:flex><span>               Last_SQL_Errno: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>               Last_SQL_Error:
</span></span><span style=display:flex><span>  Replicate_Ignore_Server_Ids:
</span></span><span style=display:flex><span>             Master_Server_Id: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>                  Master_UUID: 9d09b11c-fdeb-11e8-8ac4-0242ac140006
</span></span><span style=display:flex><span>             Master_Info_File: /var/lib/mysql/master.info
</span></span><span style=display:flex><span>                    SQL_Delay: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>          SQL_Remaining_Delay: NULL
</span></span><span style=display:flex><span>      Slave_SQL_Running_State: Slave has read all relay log; waiting <span style=color:#66d9ef>for</span> more updates
</span></span><span style=display:flex><span>           Master_Retry_Count: <span style=color:#ae81ff>86400</span>
</span></span><span style=display:flex><span>                  Master_Bind:
</span></span><span style=display:flex><span>      Last_IO_Error_Timestamp:
</span></span><span style=display:flex><span>     Last_SQL_Error_Timestamp:
</span></span><span style=display:flex><span>               Master_SSL_Crl:
</span></span><span style=display:flex><span>           Master_SSL_Crlpath:
</span></span><span style=display:flex><span>           Retrieved_Gtid_Set:
</span></span><span style=display:flex><span>            Executed_Gtid_Set:
</span></span><span style=display:flex><span>                Auto_Position: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>         Replicate_Rewrite_DB:
</span></span><span style=display:flex><span>                 Channel_Name:
</span></span><span style=display:flex><span>           Master_TLS_Version:
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> row in set <span style=color:#f92672>(</span>0.00 sec<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>如果<code>Slave_IO_Running</code>,<code>Slave_SQL_Running</code>不为<code>YES</code>,则排查以上步骤是否正确</p><p>至此配置完成</p><h3 id=laravel中相关配置>laravel中相关配置<a hidden class=anchor aria-hidden=true href=#laravel中相关配置>#</a></h3><p>在<code>config/database.php</code>中<code>mysql</code>段配置如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#e6db74>&#39;mysql&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;read&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;host&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;DB_SLAVE_HOST&#39;</span>, <span style=color:#e6db74>&#39;127.0.0.1&#39;</span>),
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;write&#39;</span> <span style=color:#f92672>=&gt;</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;host&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;DB_HOST&#39;</span>, <span style=color:#e6db74>&#39;127.0.0.1&#39;</span>),
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;sticky&#39;</span>    <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;driver&#39;</span>    <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;mysql&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;database&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;DB_DATABASE&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;username&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;DB_USERNAME&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;password&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;DB_PASSWORD&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;unix_socket&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>env</span>(<span style=color:#e6db74>&#39;DB_SOCKET&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;charset&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;utf8mb4&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;collation&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;utf8mb4_general_ci&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;prefix&#39;</span>    <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;strict&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;engine&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>],
</span></span></code></pre></div><h3 id=注意>注意<a hidden class=anchor aria-hidden=true href=#注意>#</a></h3><ul><li>如果是线上操作(持续有数据写入),则需要按照以下步骤：master锁表&ndash;>master备份数据&ndash;>master解锁表 &ndash;>slave导入数据&ndash;>slave设置主从&ndash;>查看主从</li><li>如果多个从库需要注意<ol><li>数据目录<code>auto.cnf</code>中的<code>server-uuid</code>唯一</li><li>配置文件<code>my.cnf</code>中的<code>server_id</code>唯一</li></ol></li><li>需要在从库的容器环境变量中添加<code>MASTER_HOST=主节点容器名称</code>来确保容器重启之后自动同步主库<code>binlog</code></li></ul><h3 id=错误修复>错误修复<a hidden class=anchor aria-hidden=true href=#错误修复>#</a></h3><p>如果遇到类似以下错误,可能是由于主从库之间结构不同或其他原因造成的SQL query执行失败</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SHOW</span> SLAVE STATUS <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span>
</span></span><span style=display:flex><span><span style=color:#f92672>***************************</span> <span style=color:#ae81ff>1</span>. <span style=color:#66d9ef>row</span> <span style=color:#f92672>***************************</span>
</span></span><span style=display:flex><span>             Slave_IO_State: Waiting <span style=color:#66d9ef>for</span> master <span style=color:#66d9ef>to</span> send event
</span></span><span style=display:flex><span>                Master_Host: <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>3</span>.<span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>                Master_User: slave_user
</span></span><span style=display:flex><span>                Master_Port: <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>              Connect_Retry: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>            Master_Log_File: mysql<span style=color:#f92672>-</span>bin.<span style=color:#ae81ff>001079</span>
</span></span><span style=display:flex><span>        Read_Master_Log_Pos: <span style=color:#ae81ff>269214454</span>
</span></span><span style=display:flex><span>             Relay_Log_File: slave<span style=color:#f92672>-</span>relay.<span style=color:#ae81ff>000130</span>
</span></span><span style=display:flex><span>              Relay_Log_Pos: <span style=color:#ae81ff>100125935</span>
</span></span><span style=display:flex><span>      Relay_Master_Log_File: mysql<span style=color:#f92672>-</span>bin.<span style=color:#ae81ff>001079</span>
</span></span><span style=display:flex><span>           Slave_IO_Running: Yes
</span></span><span style=display:flex><span>          Slave_SQL_Running: <span style=color:#66d9ef>No</span>
</span></span><span style=display:flex><span>            Replicate_Do_DB: mydb
</span></span><span style=display:flex><span>        Replicate_Ignore_DB:
</span></span><span style=display:flex><span>         Replicate_Do_Table:
</span></span><span style=display:flex><span>     Replicate_Ignore_Table:
</span></span><span style=display:flex><span>    Replicate_Wild_Do_Table:
</span></span><span style=display:flex><span>Replicate_Wild_Ignore_Table:
</span></span><span style=display:flex><span>                 Last_Errno: <span style=color:#ae81ff>1146</span>
</span></span><span style=display:flex><span>                 Last_Error: Error <span style=color:#e6db74>&#39;Table &#39;</span>mydb.taggregate_temp_1212047760<span style=color:#e6db74>&#39; doesn&#39;</span>t exist<span style=color:#e6db74>&#39; on query. Default database: &#39;</span>mydb<span style=color:#e6db74>&#39;. 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Query: &#39;</span><span style=color:#66d9ef>UPDATE</span> thread <span style=color:#66d9ef>AS</span> thread,taggregate_temp_1212047760 <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>aggregate</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SET</span> thread.views <span style=color:#f92672>=</span> thread.views <span style=color:#f92672>+</span> <span style=color:#66d9ef>aggregate</span>.views
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>WHERE</span> thread.threadid <span style=color:#f92672>=</span> <span style=color:#66d9ef>aggregate</span>.threadid<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               Skip_Counter: 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Exec_Master_Log_Pos: 203015142
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Relay_Log_Space: 166325247
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Until_Condition: None
</span></span></span><span style=display:flex><span><span style=color:#e6db74>             Until_Log_File:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              Until_Log_Pos: 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         Master_SSL_Allowed: No
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         Master_SSL_CA_File:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         Master_SSL_CA_Path:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Master_SSL_Cert:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          Master_SSL_Cipher:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>             Master_SSL_Key:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      Seconds_Behind_Master: NULL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>1 row in set (0.00 sec)
</span></span></span></code></pre></div><p><strong>可以通过以下步骤跳过错误</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> stop slave;<span style=color:#75715e>-- 停止
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>GLOBAL</span> SQL_SLAVE_SKIP_COUNTER <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#75715e>-- 跳过指定数量的SQL query,此处为1条
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>start</span> slave;<span style=color:#75715e>-- 开启
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>show</span> slave status <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span>;<span style=color:#75715e>-- 状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>***************************</span> <span style=color:#ae81ff>1</span>. <span style=color:#66d9ef>row</span> <span style=color:#f92672>***************************</span>
</span></span><span style=display:flex><span>               Slave_IO_State: Waiting <span style=color:#66d9ef>for</span> master <span style=color:#66d9ef>to</span> send event
</span></span><span style=display:flex><span>                  Master_Host: mysql57
</span></span><span style=display:flex><span>                  Master_User: slave
</span></span><span style=display:flex><span>                  Master_Port: <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>                Connect_Retry: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>              Master_Log_File: community<span style=color:#f92672>-</span>mysql<span style=color:#f92672>-</span>bin.<span style=color:#ae81ff>000005</span>
</span></span><span style=display:flex><span>          Read_Master_Log_Pos: <span style=color:#ae81ff>2145</span>
</span></span><span style=display:flex><span>               Relay_Log_File: community<span style=color:#f92672>-</span>mysql<span style=color:#f92672>-</span>relay<span style=color:#f92672>-</span>bin.<span style=color:#ae81ff>000010</span>
</span></span><span style=display:flex><span>                Relay_Log_Pos: <span style=color:#ae81ff>330</span>
</span></span><span style=display:flex><span>        Relay_Master_Log_File: community<span style=color:#f92672>-</span>mysql<span style=color:#f92672>-</span>bin.<span style=color:#ae81ff>000005</span>
</span></span><span style=display:flex><span>             Slave_IO_Running: Yes
</span></span><span style=display:flex><span>            Slave_SQL_Running: Yes
</span></span><span style=display:flex><span>              Replicate_Do_DB:
</span></span><span style=display:flex><span>          Replicate_Ignore_DB:
</span></span><span style=display:flex><span>           Replicate_Do_Table:
</span></span><span style=display:flex><span>       Replicate_Ignore_Table:
</span></span><span style=display:flex><span>      Replicate_Wild_Do_Table:
</span></span><span style=display:flex><span>  Replicate_Wild_Ignore_Table:
</span></span><span style=display:flex><span>                   Last_Errno: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>                   Last_Error:
</span></span><span style=display:flex><span>                 Skip_Counter: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>          Exec_Master_Log_Pos: <span style=color:#ae81ff>2145</span>
</span></span><span style=display:flex><span>              Relay_Log_Space: <span style=color:#ae81ff>2771</span>
</span></span><span style=display:flex><span>              Until_Condition: <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>               Until_Log_File:
</span></span><span style=display:flex><span>                Until_Log_Pos: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>           Master_SSL_Allowed: <span style=color:#66d9ef>No</span>
</span></span><span style=display:flex><span>           Master_SSL_CA_File:
</span></span><span style=display:flex><span>           Master_SSL_CA_Path:
</span></span><span style=display:flex><span>              Master_SSL_Cert:
</span></span><span style=display:flex><span>            Master_SSL_Cipher:
</span></span><span style=display:flex><span>               Master_SSL_Key:
</span></span><span style=display:flex><span>        Seconds_Behind_Master: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Master_SSL_Verify_Server_Cert: <span style=color:#66d9ef>No</span>
</span></span><span style=display:flex><span>                Last_IO_Errno: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>                Last_IO_Error:
</span></span><span style=display:flex><span>               Last_SQL_Errno: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>               Last_SQL_Error:
</span></span><span style=display:flex><span>  Replicate_Ignore_Server_Ids:
</span></span><span style=display:flex><span>             Master_Server_Id: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>                  Master_UUID: c28b993e<span style=color:#f92672>-</span><span style=color:#ae81ff>368</span>d<span style=color:#f92672>-</span><span style=color:#ae81ff>11</span>e9<span style=color:#f92672>-</span><span style=color:#ae81ff>96</span>c4<span style=color:#f92672>-</span><span style=color:#ae81ff>0242</span>ac120002
</span></span><span style=display:flex><span>             Master_Info_File: <span style=color:#f92672>/</span>var<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>mysql<span style=color:#f92672>/</span>master.info
</span></span><span style=display:flex><span>                    SQL_Delay: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>          SQL_Remaining_Delay: <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>      Slave_SQL_Running_State: Slave has <span style=color:#66d9ef>read</span> <span style=color:#66d9ef>all</span> relay log; waiting <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>more</span> updates
</span></span><span style=display:flex><span>           Master_Retry_Count: <span style=color:#ae81ff>86400</span>
</span></span><span style=display:flex><span>                  Master_Bind:
</span></span><span style=display:flex><span>      Last_IO_Error_Timestamp:
</span></span><span style=display:flex><span>     Last_SQL_Error_Timestamp:
</span></span><span style=display:flex><span>               Master_SSL_Crl:
</span></span><span style=display:flex><span>           Master_SSL_Crlpath:
</span></span><span style=display:flex><span>           Retrieved_Gtid_Set:
</span></span><span style=display:flex><span>            Executed_Gtid_Set:
</span></span><span style=display:flex><span>                Auto_Position: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>         Replicate_Rewrite_DB:
</span></span><span style=display:flex><span>                 Channel_Name:
</span></span><span style=display:flex><span>           Master_TLS_Version:
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ERROR:
</span></span><span style=display:flex><span><span style=color:#66d9ef>No</span> query specified
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.88886688.xyz/tags/mysql/>mysql</a></li></ul><nav class=paginav><a class=prev href=https://blog.88886688.xyz/posts/2019-03-02-openresty%E5%AE%9E%E7%8E%B0%E8%AE%BF%E9%97%AE%E9%99%90%E6%B5%81/><span class=title>« Prev</span><br><span>Openresty实现访问限流</span></a>
<a class=next href=https://blog.88886688.xyz/posts/2019-01-17-php%E5%BC%80%E5%90%AFopcache%E5%89%8D%E5%90%8E%E6%80%A7%E8%83%BD%E5%B7%AE%E5%BC%82/><span class=title>Next »</span><br><span>php开启opcache前后性能差异</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2017-2023 <a href=https://blog.88886688.xyz/>Lester's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><br><span>Email: <a href=mailto:lestat9527@gmail.com>lestat9527@gmail.com</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
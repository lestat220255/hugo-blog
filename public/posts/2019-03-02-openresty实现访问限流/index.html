<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Openresty实现访问限流 | Lester's Blog</title><meta name=keywords content="openresty"><meta name=description content="自己动手实现一个基于nginx+lua+redis的限制client访问频率+自动拉黑的限流方案"><meta name=author content><link rel=canonical href=https://blog.88886688.xyz/posts/2019-03-02-openresty%E5%AE%9E%E7%8E%B0%E8%AE%BF%E9%97%AE%E9%99%90%E6%B5%81/><link crossorigin=anonymous href=/assets/css/stylesheet.84a638ec294a2a547ea8ea3f2466d240b38b987cbbb815b534c0442ed8d517d7.css integrity="sha256-hKY47ClKKlR+qOo/JGbSQLOLmHy7uBW1NMBELtjVF9c=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.88886688.xyz/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.88886688.xyz/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.88886688.xyz/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.88886688.xyz/apple-touch-icon.png><link rel=mask-icon href=https://blog.88886688.xyz/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Openresty实现访问限流"><meta property="og:description" content="自己动手实现一个基于nginx+lua+redis的限制client访问频率+自动拉黑的限流方案"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.88886688.xyz/posts/2019-03-02-openresty%E5%AE%9E%E7%8E%B0%E8%AE%BF%E9%97%AE%E9%99%90%E6%B5%81/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-02T22:39:11+00:00"><meta property="article:modified_time" content="2019-03-02T22:39:11+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Openresty实现访问限流"><meta name=twitter:description content="自己动手实现一个基于nginx+lua+redis的限制client访问频率+自动拉黑的限流方案"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.88886688.xyz/posts/"},{"@type":"ListItem","position":2,"name":"Openresty实现访问限流","item":"https://blog.88886688.xyz/posts/2019-03-02-openresty%E5%AE%9E%E7%8E%B0%E8%AE%BF%E9%97%AE%E9%99%90%E6%B5%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Openresty实现访问限流","name":"Openresty实现访问限流","description":"自己动手实现一个基于nginx+lua+redis的限制client访问频率+自动拉黑的限流方案","keywords":["openresty"],"articleBody":"基本概念 Nginx：高性能、高并发的Web服务器，拥有丰富的第三方模块。 Lua：一种轻量级、可嵌入式的脚本语言。 Ngx_lua：Nginx的一个模块，将Lua嵌入到Nginx中，这样就可以使用Lua编写应用脚本，部署到Nginx中运行，即Nginx变成了一个Web容器，这样开发人员就可以使用Lua语言开发高性能Web应用了。 引用官网的一个描述:\nOpenResty® 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。\n应用场景 在 Lua 中混合处理不同 Nginx 模块输出（proxy, drizzle, postgres, Redis, memcached 等）。 在请求真正到达上游服务之前，Lua 中处理复杂的准入控制和安全检查。 比较随意的控制应答头（通过 Lua）。 从外部存储中获取后端信息，并用这些信息来实时选择哪一个后端来完成业务访问。 在内容 handler 中随意编写复杂的 web 应用，同步编写异步访问后端数据库和其他存储。 在 rewrite 阶段，通过 Lua 完成非常复杂的处理。 在 Nginx 子查询、location 调用中，通过 Lua 实现高级缓存机制。 对外暴露强劲的 Lua 语言，允许使用各种 Nginx 模块，自由拼合没有任何限制。该模块的脚本有充分的灵活性，同时提供的性能水平与本地 C 语言程序无论是在 CPU 时间方面以及内存占用差距非常小。所有这些都要求 LuaJIT 2.x 是启用的。其他脚本语言实现通常很难满足这一性能水平。 LuaNginxModule的执行阶段 set_by_lua*: 流程分支处理判断变量初始化 rewrite_by_lua*: 转发、重定向、缓存等功能(例如特定请求代理到外网) access_by_lua*: IP 准入、接口权限等情况集中处理(例如配合 iptable 完成简单防火墙) content_by_lua*: 内容生成 header_filter_by_lua*: 响应头部过滤处理(例如添加头部信息) body_filter_by_lua*: 响应体过滤处理(例如完成应答内容统一成大写) log_by_lua*: 会话完成后本地异步完成日志记录(日志可以记录在本地，还可以同步到其他机器) 限流的实现 由于近期工作中所负责的项目是开发App和一个前后端分离的管理系统的数据接口(统一采用jwt作为身份认证方式),且第一期已经接近尾声,因此除了做一些php代码层面的缓存优化之外,想到了需要学习一下除了bloomfilter之外的防止缓存穿透的办法(直接在web服务器层面通过redis动态限制访问频率,优点,性能损耗小,全程没有php参与),碰巧网上看到了Openresty,又是基于nginx(熟悉的配方),又能解决当下遇到的问题(神奇的味道),于是经过了几天的学习,也参考了一些其他博客中类似的实现,现记录下本人目前动态限流的实现过程\nopenresty下的nginx目录大致这样一个结构(只需看有注释的位置)\n|-- client_body_temp |-- conf | |-- fastcgi.conf | |-- fastcgi.conf.default | |-- fastcgi_params | |-- fastcgi_params.default | |-- koi-utf | |-- koi-win | |-- mime.types | |-- mime.types.default | |-- nginx.conf #主配置文件 | |-- nginx.conf.default | |-- scgi_params | |-- scgi_params.default | |-- uwsgi_params | |-- uwsgi_params.default | `-- win-utf |-- fastcgi_temp |-- html | |-- 50x.html | `-- index.html |-- logs | |-- access.log -\u003e /dev/stdout | |-- error.log -\u003e /dev/stderr | `-- nginx.pid |-- lua | |-- lua-cjson | `-- lua-resty-redis |-- proxy_temp |-- sbin | |-- nginx | `-- stap-nginx |-- scgi_temp |-- src #自定义lua脚本目录 | |-- access_flow_control.lua | |-- access_limit.lua | |-- access_limit_by_specific_rules.lua #将使用的动态限流脚本 | `-- handle_logs.lua |-- tapset | |-- nginx.stp | `-- ngx_lua.stp `-- uwsgi_temp 在nginx.conf中加入如下配置\nresolver 127.0.0.11 ipv6=off;#由于当前openresty安装在docker内,因此为了lua脚本中的hostname能被正确解析,添加此配置 lua_code_cache off;#关闭lua代码缓存,每次代码更新后无需重启nginx即可生效 server_tokens off;#隐藏openresty版本号 在conf.d/default.conf中的相应location的access阶段挂载lua脚本\nlocation ~ \\.php$ { #lua_need_request_body on; access_by_lua_file src/access_limit_by_specific_rules.lua;#在到达php处理前首先由挂载的lua脚本处理 fastcgi_pass php72:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; } access_limit_by_specific_rules.lua:\n-- local cjson = require \"cjson\" local function close_redis(red) if not red then return end --释放连接(连接池实现) local pool_max_idle_time = 10000 --毫秒 local pool_size = 100 --连接池大小 local ok, err = red:set_keepalive(pool_max_idle_time, pool_size) if not ok then ngx.log(ngx.ERR, \"set redis keepalive error : \", err) end end -- ip最大频率 local ipMaxFreq = 9 -- token最大频率 local tokenMaxFreq = 9 -- 超过阈值后被ban时间 local banExpire = 600 --[[ 初始化redis ]] local redis = require \"resty.redis\" local red = redis:new() red:set_timeout(1000) local host = 'redis' local port = 6379 local ok, err = red:connect(host,port) if not ok then return close_redis(red) end -- 请注意这里 auth 的调用过程 -- local count -- count, err = red:get_reused_times() -- if 0 == count then -- ok, err = red:auth(\"password\") -- if not ok then -- ngx.say(\"failed to auth: \", err) -- return -- end -- elseif err then -- ngx.say(\"failed to get reused times: \", err) -- return -- end --[[ 优先判断是否存在token ]] --token名称,此处根据实际情况修改 local token = \"Authorization\" clientToken = ngx.req.get_headers()[token] --[[ 获取客户端真实IP ]] local clientIP = ngx.req.get_headers()[\"X-Real-IP\"] if clientIP == nil then clientIP = ngx.req.get_headers()[\"x_forwarded_for\"] end if clientIP == nil then clientIP = ngx.var.remote_addr end -- 获取所有cookie，这里获取到的是一个字符串，如果不存在则返回nil -- local clientHttpCookie = ngx.var.http_cookie -- 获取单个cookie，_后面的cookie的name，如果不存在则返回nil local clientCookie = ngx.var.http_cookie if clientToken ~= nil then local incrKey = \"user:\"..clientToken..\":freq\" local tokenBlockKey = \"userToken:\"..clientToken..\":block\" local ipBlockKey = \"userIp:\"..clientIP..\":block\" --[[ 判断是否被ban ]] local is_block,err = red:get(tokenBlockKey) -- check if token is blocked if tonumber(is_block) == 1 then ngx.exit(ngx.HTTP_FORBIDDEN) return close_redis(red) end local is_block,err = red:get(ipBlockKey) -- check if ip is blocked if tonumber(is_block) == 1 then ngx.exit(ngx.HTTP_FORBIDDEN) return close_redis(red) end --[[ 每秒访问频率+1 ]] res, err = red:incr(incrKey) --[[ 上一步操作成功,则为当前key设置过期时间 ]] if res == 1 then res, err = red:expire(incrKey,1) end --[[ 每秒请求数大于阈值,屏蔽指定值(秒) ]] if res \u003e tokenMaxFreq then -- ban token res, err = red:set(tokenBlockKey,1) res, err = red:expire(tokenBlockKey,banExpire) -- ban ip res, err = red:set(ipBlockKey,1) res, err = red:expire(ipBlockKey,banExpire) -- ngx.log(ngx.ERR, tokenBlockKey) -- ngx.log(ngx.ERR, ipBlockKey) end elseif clientCookie ~= nil then local incrKey = \"user:\"..clientCookie..\":freq\" local cookieBlockKey = \"userToken:\"..clientCookie..\":block\" local ipBlockKey = \"userIp:\"..clientIP..\":block\" --[[ 判断是否被ban ]] local is_block,err = red:get(cookieBlockKey) -- check if token is blocked if tonumber(is_block) == 1 then ngx.exit(ngx.HTTP_FORBIDDEN) return close_redis(red) end local is_block,err = red:get(ipBlockKey) -- check if ip is blocked if tonumber(is_block) == 1 then ngx.exit(ngx.HTTP_FORBIDDEN) return close_redis(red) end --[[ 每秒访问频率+1 ]] res, err = red:incr(incrKey) --[[ 上一步操作成功,则为当前key设置过期时间 ]] if res == 1 then res, err = red:expire(incrKey,1) end --[[ 每秒请求数大于阈值,屏蔽指定值(秒) ]] if res \u003e tokenMaxFreq then -- ban cookie res, err = red:set(cookieBlockKey,1) res, err = red:expire(cookieBlockKey,banExpire) -- ban ip res, err = red:set(ipBlockKey,1) res, err = red:expire(ipBlockKey,banExpire) -- ngx.log(ngx.ERR, cookieBlockKey) -- ngx.log(ngx.ERR, ipBlockKey) end else local incrKey = \"user:\"..clientIP..\":freq\" local blockKey = \"userIp:\"..clientIP..\":block\" --[[ 判断是否被ban ]] local is_block,err = red:get(blockKey) -- check if ip is blocked if tonumber(is_block) == 1 then ngx.exit(ngx.HTTP_FORBIDDEN) return close_redis(red) end --[[ 每秒访问频率+1 ]] res, err = red:incr(incrKey) --[[ 上一步操作成功,则为当前key设置过期时间 ]] if res == 1 then res, err = red:expire(incrKey,1) end --[[ 每秒请求数大于阈值,屏蔽指定值(秒) ]] if res \u003e ipMaxFreq then res, err = red:set(blockKey,1) res, err = red:expire(blockKey,banExpire) end end --[[ 关闭redis ]] close_redis(red) 以上代码处理了请求可能携带token/cookie或直接访问的情况;对直接访问的请求通过ip识别身份(但一个ip可能对应多个client),因此配置一个较高的每秒频率,超过频率后对ip进行全局forbidden至指定时间;对携带token/cookie访问的请求通过token/cookie识别身份(通常是同一个client),设置一个较低的频率,超过频率后对该token/cookie和其所在ip进行全局forbidden至指定时间\n完成配置后,重启服务器\nnginx -s reload 效果对比 注意ab test的一个坑,用于测试的文件需要保证每一次返回的html长度一致,否则ab test会判定为length failure,影响最终结果(当然也可以忽略它),参考\n1 . 频率限制前,ab -n 100 -c 10 localhost/index.php\n➜ ~ ab -n 100 -c 10 localhost/index.php This is ApacheBench, Version 2.3 \u003c$Revision: 1843412 $\u003e Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking localhost (be patient).....done Server Software: openresty Server Hostname: localhost Server Port: 80 Document Path: /index.php Document Length: 3 bytes Concurrency Level: 10 Time taken for tests: 0.106 seconds Complete requests: 100 Failed requests: 0 Total transferred: 16300 bytes HTML transferred: 300 bytes Requests per second: 941.97 [#/sec] (mean) Time per request: 10.616 [ms] (mean) Time per request: 1.062 [ms] (mean, across all concurrent requests) Transfer rate: 149.94 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 1 1.8 0 7 Processing: 2 9 2.2 9 16 Waiting: 0 9 2.4 9 16 Total: 5 10 3.0 9 19 Percentage of the requests served within a certain time (ms) 50% 9 66% 9 75% 10 80% 11 90% 15 95% 18 98% 19 99% 19 100% 19 (longest request) 2 . 频率限制后(限制为9),ab -n 100 -c 10 localhost/index.php\n➜ ~ ab -n 100 -c 10 localhost/index.php This is ApacheBench, Version 2.3 \u003c$Revision: 1843412 $\u003e Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking localhost (be patient).....done Server Software: openresty Server Hostname: localhost Server Port: 80 Document Path: /index.php Document Length: 3 bytes Concurrency Level: 10 Time taken for tests: 0.088 seconds Complete requests: 100 Failed requests: 89 (Connect: 0, Receive: 0, Length: 89, Exceptions: 0) Non-2xx responses: 89 Total transferred: 29650 bytes HTML transferred: 14807 bytes Requests per second: 1131.03 [#/sec] (mean) Time per request: 8.841 [ms] (mean) Time per request: 0.884 [ms] (mean, across all concurrent requests) Transfer rate: 327.49 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 0 0.2 0 1 Processing: 4 8 1.5 8 15 Waiting: 4 8 1.5 8 15 Total: 4 8 1.5 8 15 Percentage of the requests served within a certain time (ms) 50% 8 66% 9 75% 9 80% 9 90% 10 95% 10 98% 14 99% 15 100% 15 (longest request) 3 . 频率限制前,ab -n 100 -c 10 -H 'Authorization: Bearer TestToken' localhost/index.php\n➜ ~ ab -n 100 -c 10 -H 'Authorization: Bearer TestToken' localhost/index.php This is ApacheBench, Version 2.3 \u003c$Revision: 1843412 $\u003e Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking localhost (be patient).....done Server Software: openresty Server Hostname: localhost Server Port: 80 Document Path: /index.php Document Length: 3 bytes Concurrency Level: 10 Time taken for tests: 0.097 seconds Complete requests: 100 Failed requests: 0 Total transferred: 16300 bytes HTML transferred: 300 bytes Requests per second: 1028.65 [#/sec] (mean) Time per request: 9.721 [ms] (mean) Time per request: 0.972 [ms] (mean, across all concurrent requests) Transfer rate: 163.74 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 0 0.1 0 1 Processing: 3 9 1.5 9 14 Waiting: 2 9 1.5 9 14 Total: 3 9 1.6 9 14 Percentage of the requests served within a certain time (ms) 50% 9 66% 10 75% 10 80% 11 90% 11 95% 12 98% 13 99% 14 100% 14 (longest request) 4 . 频率限制后(限制为9),ab -n 100 -c 10 -H 'Authorization: Bearer TestToken' localhost/index.php\n➜ ~ ab -n 100 -c 10 -H 'Authorization: Bearer TestToken' localhost/index.php This is ApacheBench, Version 2.3 \u003c$Revision: 1843412 $\u003e Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking localhost (be patient).....done Server Software: openresty Server Hostname: localhost Server Port: 80 Document Path: /index.php Document Length: 3 bytes Concurrency Level: 10 Time taken for tests: 0.076 seconds Complete requests: 100 Failed requests: 89 (Connect: 0, Receive: 0, Length: 89, Exceptions: 0) Non-2xx responses: 89 Total transferred: 29650 bytes HTML transferred: 14807 bytes Requests per second: 1307.21 [#/sec] (mean) Time per request: 7.650 [ms] (mean) Time per request: 0.765 [ms] (mean, across all concurrent requests) Transfer rate: 378.50 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 0 0 0.1 0 0 Processing: 2 7 1.2 7 14 Waiting: 2 7 1.2 7 14 Total: 2 7 1.2 7 14 Percentage of the requests served within a certain time (ms) 50% 7 66% 7 75% 8 80% 8 90% 8 95% 9 98% 12 99% 14 100% 14 (longest request) 5 . 在redis-cli中也可以获取到block数据\n127.0.0.1:6379\u003e get userIp:172.27.0.1:block \"1\" 其他 以上请求频率限制+自动拉黑一段时间的方式可以一定程度上拦截一些恶意请求,误伤小,让通过脚本携带token/cookie进行大量请求攻击难度变大 最近把自己本地的开发环境发布到了github上,以方便在任何地方都可以快速搭建自己用着顺手的开发环境 redis的key太长(目前用token作为key)会明显影响性能吗?答案是:不会 参考网址 关于docker容器内的DNS服务器地址为127.0.0.11的官方说明 ","wordCount":"1477","inLanguage":"en","datePublished":"2019-03-02T22:39:11.923Z","dateModified":"2019-03-02T22:39:11.923Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.88886688.xyz/posts/2019-03-02-openresty%E5%AE%9E%E7%8E%B0%E8%AE%BF%E9%97%AE%E9%99%90%E6%B5%81/"},"publisher":{"@type":"Organization","name":"Lester's Blog","logo":{"@type":"ImageObject","url":"https://blog.88886688.xyz/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.88886688.xyz/ accesskey=h title="Lester's Blog (Alt + H)">Lester's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.88886688.xyz/ title="Lester's Blog"><span>Home</span></a></li><li><a href=https://blog.88886688.xyz/tags/ title=Tags><span>Tags/分类</span></a></li><li><a href=https://blog.88886688.xyz/about/ title="About Me"><span>About/关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.88886688.xyz/>Home</a>&nbsp;»&nbsp;<a href=https://blog.88886688.xyz/posts/>Posts</a></div><h1 class=post-title>Openresty实现访问限流</h1><div class=post-description>自己动手实现一个基于nginx+lua+redis的限制client访问频率+自动拉黑的限流方案</div><div class=post-meta><span title='2019-03-02 22:39:11.923 +0000 UTC'>March 2, 2019</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1477 words</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 aria-label=基本概念>基本概念</a></li><li><a href=#%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af aria-label=应用场景>应用场景</a></li><li><a href=#luanginxmodule%e7%9a%84%e6%89%a7%e8%a1%8c%e9%98%b6%e6%ae%b5 aria-label=LuaNginxModule的执行阶段>LuaNginxModule的执行阶段</a></li><li><a href=#%e9%99%90%e6%b5%81%e7%9a%84%e5%ae%9e%e7%8e%b0 aria-label=限流的实现>限流的实现</a></li><li><a href=#%e6%95%88%e6%9e%9c%e5%af%b9%e6%af%94 aria-label=效果对比>效果对比</a></li><li><a href=#%e5%85%b6%e4%bb%96 aria-label=其他>其他</a></li></ul></div></details></div><div class=post-content><h2 id=基本概念>基本概念<a hidden class=anchor aria-hidden=true href=#基本概念>#</a></h2><p><img loading=lazy src=https://ws1.sinaimg.cn/large/005NqLEEgy1g0oepurdfuj30b406tjsd.jpg alt></p><ul><li>Nginx：高性能、高并发的Web服务器，拥有丰富的第三方模块。</li><li>Lua：一种轻量级、可嵌入式的脚本语言。</li><li>Ngx_lua：Nginx的一个模块，将Lua嵌入到Nginx中，这样就可以使用Lua编写应用脚本，部署到Nginx中运行，即Nginx变成了一个Web容器，这样开发人员就可以使用Lua语言开发高性能Web应用了。</li></ul><p><strong>引用官网的一个描述:</strong></p><blockquote><p>OpenResty® 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用 Nginx 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。</p></blockquote><h2 id=应用场景>应用场景<a hidden class=anchor aria-hidden=true href=#应用场景>#</a></h2><ul><li>在 Lua 中混合处理不同 Nginx 模块输出（proxy, drizzle, postgres, Redis, memcached 等）。</li><li>在请求真正到达上游服务之前，Lua 中处理复杂的准入控制和安全检查。</li><li>比较随意的控制应答头（通过 Lua）。</li><li>从外部存储中获取后端信息，并用这些信息来实时选择哪一个后端来完成业务访问。</li><li>在内容 handler 中随意编写复杂的 web 应用，同步编写异步访问后端数据库和其他存储。</li><li>在 rewrite 阶段，通过 Lua 完成非常复杂的处理。</li><li>在 Nginx 子查询、location 调用中，通过 Lua 实现高级缓存机制。</li><li>对外暴露强劲的 Lua 语言，允许使用各种 Nginx 模块，自由拼合没有任何限制。该模块的脚本有充分的灵活性，同时提供的性能水平与本地 C 语言程序无论是在 CPU 时间方面以及内存占用差距非常小。所有这些都要求 LuaJIT 2.x 是启用的。其他脚本语言实现通常很难满足这一性能水平。</li></ul><h2 id=luanginxmodule的执行阶段>LuaNginxModule的执行阶段<a hidden class=anchor aria-hidden=true href=#luanginxmodule的执行阶段>#</a></h2><p><img loading=lazy src=https://ws1.sinaimg.cn/large/005NqLEEgy1g0oeyqe5ujj30rx0pawfh.jpg alt></p><ul><li>set_by_lua*: 流程分支处理判断变量初始化</li><li>rewrite_by_lua*: 转发、重定向、缓存等功能(例如特定请求代理到外网)</li><li>access_by_lua*: IP 准入、接口权限等情况集中处理(例如配合 iptable 完成简单防火墙)</li><li>content_by_lua*: 内容生成</li><li>header_filter_by_lua*: 响应头部过滤处理(例如添加头部信息)</li><li>body_filter_by_lua*: 响应体过滤处理(例如完成应答内容统一成大写)</li><li>log_by_lua*: 会话完成后本地异步完成日志记录(日志可以记录在本地，还可以同步到其他机器)</li></ul><h2 id=限流的实现>限流的实现<a hidden class=anchor aria-hidden=true href=#限流的实现>#</a></h2><blockquote><p>由于近期工作中所负责的项目是开发App和一个前后端分离的管理系统的数据接口(统一采用jwt作为身份认证方式),且第一期已经接近尾声,因此除了做一些php代码层面的缓存优化之外,想到了需要学习一下除了bloomfilter之外的防止缓存穿透的办法(直接在web服务器层面通过redis动态限制访问频率,优点,性能损耗小,全程没有php参与),碰巧网上看到了Openresty,又是基于nginx(熟悉的配方),又能解决当下遇到的问题(神奇的味道),于是经过了几天的学习,也参考了一些其他博客中类似的实现,现记录下本人目前动态限流的实现过程</p></blockquote><ol><li><p>openresty下的nginx目录大致这样一个结构(只需看有注释的位置)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> |-- client_body_temp
</span></span><span style=display:flex><span> |-- conf
</span></span><span style=display:flex><span> |   |-- fastcgi.conf
</span></span><span style=display:flex><span> |   |-- fastcgi.conf.default
</span></span><span style=display:flex><span> |   |-- fastcgi_params
</span></span><span style=display:flex><span> |   |-- fastcgi_params.default
</span></span><span style=display:flex><span> |   |-- koi-utf
</span></span><span style=display:flex><span> |   |-- koi-win
</span></span><span style=display:flex><span> |   |-- mime.types
</span></span><span style=display:flex><span> |   |-- mime.types.default
</span></span><span style=display:flex><span> |   |-- nginx.conf <span style=color:#75715e>#主配置文件</span>
</span></span><span style=display:flex><span> |   |-- nginx.conf.default
</span></span><span style=display:flex><span> |   |-- scgi_params
</span></span><span style=display:flex><span> |   |-- scgi_params.default
</span></span><span style=display:flex><span> |   |-- uwsgi_params
</span></span><span style=display:flex><span> |   |-- uwsgi_params.default
</span></span><span style=display:flex><span> |   <span style=color:#e6db74>`</span>-- win-utf
</span></span><span style=display:flex><span> |-- fastcgi_temp
</span></span><span style=display:flex><span> |-- html
</span></span><span style=display:flex><span> |   |-- 50x.html
</span></span><span style=display:flex><span> |   <span style=color:#e6db74>`</span>-- index.html
</span></span><span style=display:flex><span> |-- logs
</span></span><span style=display:flex><span> |   |-- access.log -&gt; /dev/stdout
</span></span><span style=display:flex><span> |   |-- error.log -&gt; /dev/stderr
</span></span><span style=display:flex><span> |   <span style=color:#e6db74>`</span>-- nginx.pid
</span></span><span style=display:flex><span> |-- lua
</span></span><span style=display:flex><span> |   |-- lua-cjson
</span></span><span style=display:flex><span> |   <span style=color:#e6db74>`</span>-- lua-resty-redis
</span></span><span style=display:flex><span> |-- proxy_temp
</span></span><span style=display:flex><span> |-- sbin
</span></span><span style=display:flex><span> |   |-- nginx
</span></span><span style=display:flex><span> |   <span style=color:#e6db74>`</span>-- stap-nginx
</span></span><span style=display:flex><span> |-- scgi_temp
</span></span><span style=display:flex><span> |-- src <span style=color:#75715e>#自定义lua脚本目录</span>
</span></span><span style=display:flex><span> |   |-- access_flow_control.lua
</span></span><span style=display:flex><span> |   |-- access_limit.lua
</span></span><span style=display:flex><span> |   |-- access_limit_by_specific_rules.lua <span style=color:#75715e>#将使用的动态限流脚本</span>
</span></span><span style=display:flex><span> |   <span style=color:#e6db74>`</span>-- handle_logs.lua
</span></span><span style=display:flex><span> |-- tapset
</span></span><span style=display:flex><span> |   |-- nginx.stp
</span></span><span style=display:flex><span> |   <span style=color:#e6db74>`</span>-- ngx_lua.stp
</span></span><span style=display:flex><span> <span style=color:#e6db74>`</span>-- uwsgi_temp
</span></span></code></pre></div></li><li><p>在<code>nginx.conf</code>中加入如下配置</p><pre tabindex=0><code class=language-conf data-lang=conf> resolver 127.0.0.11 ipv6=off;#由于当前openresty安装在docker内,因此为了lua脚本中的hostname能被正确解析,添加此配置
 lua_code_cache off;#关闭lua代码缓存,每次代码更新后无需重启nginx即可生效
 server_tokens off;#隐藏openresty版本号
</code></pre></li><li><p>在<code>conf.d/default.conf</code>中的相应<code>location</code>的<code>access</code>阶段挂载lua脚本</p><pre tabindex=0><code class=language-conf data-lang=conf>location ~ \.php$ {
    #lua_need_request_body on;
    access_by_lua_file src/access_limit_by_specific_rules.lua;#在到达php处理前首先由挂载的lua脚本处理
    fastcgi_pass   php72:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include        fastcgi_params;
}
</code></pre></li><li><p><code>access_limit_by_specific_rules.lua</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span> <span style=color:#75715e>-- local cjson = require &#34;cjson&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>close_redis</span>(red)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> red <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--释放连接(连接池实现)</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> pool_max_idle_time <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000</span> <span style=color:#75715e>--毫秒</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> pool_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#75715e>--连接池大小</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> ok, err <span style=color:#f92672>=</span> red:set_keepalive(pool_max_idle_time, pool_size)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ok <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;set redis keepalive error : &#34;</span>, err)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- ip最大频率</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> ipMaxFreq <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- token最大频率</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> tokenMaxFreq <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- 超过阈值后被ban时间</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> banExpire <span style=color:#f92672>=</span> <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>     初始化redis
</span></span></span><span style=display:flex><span><span style=color:#75715e> ]]</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> redis <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;resty.redis&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> red <span style=color:#f92672>=</span> redis:new()
</span></span><span style=display:flex><span> red:set_timeout(<span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;redis&#39;</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> port <span style=color:#f92672>=</span> <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> ok, err <span style=color:#f92672>=</span> red:connect(host,port)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ok <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>return</span> close_redis(red)
</span></span><span style=display:flex><span> <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- 请注意这里 auth 的调用过程</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- local count</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- count, err = red:get_reused_times()</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- if 0 == count then</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--     ok, err = red:auth(&#34;password&#34;)</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--     if not ok then</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--         ngx.say(&#34;failed to auth: &#34;, err)</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--         return</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--     end</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- elseif err then</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--     ngx.say(&#34;failed to get reused times: &#34;, err)</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--     return</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>     优先判断是否存在token
</span></span></span><span style=display:flex><span><span style=color:#75715e> ]]</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--token名称,此处根据实际情况修改</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Authorization&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> clientToken <span style=color:#f92672>=</span> ngx.req.get_headers()[token]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>     获取客户端真实IP
</span></span></span><span style=display:flex><span><span style=color:#75715e> ]]</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> clientIP <span style=color:#f92672>=</span> ngx.req.get_headers()[<span style=color:#e6db74>&#34;X-Real-IP&#34;</span>]
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> clientIP <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>     clientIP <span style=color:#f92672>=</span> ngx.req.get_headers()[<span style=color:#e6db74>&#34;x_forwarded_for&#34;</span>]
</span></span><span style=display:flex><span> <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> clientIP <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>     clientIP <span style=color:#f92672>=</span> ngx.var.remote_addr
</span></span><span style=display:flex><span> <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- 获取所有cookie，这里获取到的是一个字符串，如果不存在则返回nil</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- local clientHttpCookie = ngx.var.http_cookie</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>-- 获取单个cookie，_后面的cookie的name，如果不存在则返回nil</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>local</span> clientCookie <span style=color:#f92672>=</span> ngx.var.http_cookie
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> clientToken <span style=color:#f92672>~=</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> incrKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;user:&#34;</span><span style=color:#f92672>..</span>clientToken<span style=color:#f92672>..</span><span style=color:#e6db74>&#34;:freq&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> tokenBlockKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;userToken:&#34;</span><span style=color:#f92672>..</span>clientToken<span style=color:#f92672>..</span><span style=color:#e6db74>&#34;:block&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> ipBlockKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;userIp:&#34;</span><span style=color:#f92672>..</span>clientIP<span style=color:#f92672>..</span><span style=color:#e6db74>&#34;:block&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         判断是否被ban
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> is_block,err <span style=color:#f92672>=</span> red:get(tokenBlockKey) <span style=color:#75715e>-- check if token is blocked</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> tonumber(is_block) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         ngx.exit(ngx.HTTP_FORBIDDEN)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> close_redis(red)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> is_block,err <span style=color:#f92672>=</span> red:get(ipBlockKey) <span style=color:#75715e>-- check if ip is blocked</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> tonumber(is_block) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         ngx.exit(ngx.HTTP_FORBIDDEN)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> close_redis(red)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>     每秒访问频率+1
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     res, err <span style=color:#f92672>=</span> red:incr(incrKey)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         上一步操作成功,则为当前key设置过期时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> res <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:expire(incrKey,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         每秒请求数大于阈值,屏蔽指定值(秒)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> res <span style=color:#f92672>&gt;</span> tokenMaxFreq <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>-- ban token</span>
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:set(tokenBlockKey,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:expire(tokenBlockKey,banExpire)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>-- ban ip</span>
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:set(ipBlockKey,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:expire(ipBlockKey,banExpire)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>-- ngx.log(ngx.ERR, tokenBlockKey)</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>-- ngx.log(ngx.ERR, ipBlockKey)</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>elseif</span> clientCookie <span style=color:#f92672>~=</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> incrKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;user:&#34;</span><span style=color:#f92672>..</span>clientCookie<span style=color:#f92672>..</span><span style=color:#e6db74>&#34;:freq&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> cookieBlockKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;userToken:&#34;</span><span style=color:#f92672>..</span>clientCookie<span style=color:#f92672>..</span><span style=color:#e6db74>&#34;:block&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> ipBlockKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;userIp:&#34;</span><span style=color:#f92672>..</span>clientIP<span style=color:#f92672>..</span><span style=color:#e6db74>&#34;:block&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         判断是否被ban
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> is_block,err <span style=color:#f92672>=</span> red:get(cookieBlockKey) <span style=color:#75715e>-- check if token is blocked</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> tonumber(is_block) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         ngx.exit(ngx.HTTP_FORBIDDEN)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> close_redis(red)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> is_block,err <span style=color:#f92672>=</span> red:get(ipBlockKey) <span style=color:#75715e>-- check if ip is blocked</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> tonumber(is_block) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         ngx.exit(ngx.HTTP_FORBIDDEN)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> close_redis(red)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>     每秒访问频率+1
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     res, err <span style=color:#f92672>=</span> red:incr(incrKey)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         上一步操作成功,则为当前key设置过期时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> res <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:expire(incrKey,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         每秒请求数大于阈值,屏蔽指定值(秒)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> res <span style=color:#f92672>&gt;</span> tokenMaxFreq <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>-- ban cookie</span>
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:set(cookieBlockKey,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:expire(cookieBlockKey,banExpire)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>-- ban ip</span>
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:set(ipBlockKey,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:expire(ipBlockKey,banExpire)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>-- ngx.log(ngx.ERR, cookieBlockKey)</span>
</span></span><span style=display:flex><span>         <span style=color:#75715e>-- ngx.log(ngx.ERR, ipBlockKey)</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> incrKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;user:&#34;</span><span style=color:#f92672>..</span>clientIP<span style=color:#f92672>..</span><span style=color:#e6db74>&#34;:freq&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> blockKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;userIp:&#34;</span><span style=color:#f92672>..</span>clientIP<span style=color:#f92672>..</span><span style=color:#e6db74>&#34;:block&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         判断是否被ban
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>local</span> is_block,err <span style=color:#f92672>=</span> red:get(blockKey) <span style=color:#75715e>-- check if ip is blocked</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> tonumber(is_block) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         ngx.exit(ngx.HTTP_FORBIDDEN)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>return</span> close_redis(red)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         每秒访问频率+1
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     res, err <span style=color:#f92672>=</span> red:incr(incrKey)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         上一步操作成功,则为当前key设置过期时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> res <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:expire(incrKey,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>         每秒请求数大于阈值,屏蔽指定值(秒)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     ]]</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>if</span> res <span style=color:#f92672>&gt;</span> ipMaxFreq <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:set(blockKey,<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>         res, err <span style=color:#f92672>=</span> red:expire(blockKey,banExpire)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e>--[[
</span></span></span><span style=display:flex><span><span style=color:#75715e>     关闭redis
</span></span></span><span style=display:flex><span><span style=color:#75715e> ]]</span>
</span></span><span style=display:flex><span> close_redis(red)
</span></span></code></pre></div><blockquote><p><strong>以上代码处理了请求可能携带token/cookie或直接访问的情况;对直接访问的请求通过ip识别身份(但一个ip可能对应多个client),因此配置一个较高的每秒频率,超过频率后对ip进行全局forbidden至指定时间;对携带token/cookie访问的请求通过token/cookie识别身份(通常是同一个client),设置一个较低的频率,超过频率后对该token/cookie和其所在ip进行全局forbidden至指定时间</strong></p></blockquote></li><li><p>完成配置后,重启服务器</p><pre tabindex=0><code> nginx -s reload
</code></pre></li></ol><h2 id=效果对比>效果对比<a hidden class=anchor aria-hidden=true href=#效果对比>#</a></h2><blockquote><p>注意ab test的一个坑,用于测试的文件需要保证每一次返回的html长度一致,否则ab test会判定为<code>length failure</code>,影响最终结果(当然也可以忽略它),<a href=https://stackoverflow.com/questions/579450/load-testing-with-ab-fake-failed-requests-length>参考</a></p></blockquote><p>1 . 频率限制前,<code>ab -n 100 -c 10 localhost/index.php</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> ➜  ~ ab -n <span style=color:#ae81ff>100</span> -c <span style=color:#ae81ff>10</span> localhost/index.php   
</span></span><span style=display:flex><span> This is ApacheBench, Version 2.3 &lt;$Revision: <span style=color:#ae81ff>1843412</span> $&gt;
</span></span><span style=display:flex><span> Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span></span><span style=display:flex><span> Licensed to The Apache Software Foundation, http://www.apache.org/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Benchmarking localhost <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>.....done
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Server Software:        openresty
</span></span><span style=display:flex><span> Server Hostname:        localhost
</span></span><span style=display:flex><span> Server Port:            <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Document Path:          /index.php
</span></span><span style=display:flex><span> Document Length:        <span style=color:#ae81ff>3</span> bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Concurrency Level:      <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> Time taken <span style=color:#66d9ef>for</span> tests:   0.106 seconds
</span></span><span style=display:flex><span> Complete requests:      <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span> Failed requests:        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> Total transferred:      <span style=color:#ae81ff>16300</span> bytes
</span></span><span style=display:flex><span> HTML transferred:       <span style=color:#ae81ff>300</span> bytes
</span></span><span style=display:flex><span> Requests per second:    941.97 <span style=color:#f92672>[</span><span style=color:#75715e>#/sec] (mean)</span>
</span></span><span style=display:flex><span> Time per request:       10.616 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Time per request:       1.062 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean, across all concurrent requests<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Transfer rate:          149.94 <span style=color:#f92672>[</span>Kbytes/sec<span style=color:#f92672>]</span> received
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Connection Times <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             min  mean<span style=color:#f92672>[</span>+/-sd<span style=color:#f92672>]</span> median   max
</span></span><span style=display:flex><span> Connect:        <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>1</span>   1.8      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span> Processing:     <span style=color:#ae81ff>2</span>    <span style=color:#ae81ff>9</span>   2.2      <span style=color:#ae81ff>9</span>      <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span> Waiting:        <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>9</span>   2.4      <span style=color:#ae81ff>9</span>      <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span> Total:          <span style=color:#ae81ff>5</span>   <span style=color:#ae81ff>10</span>   3.0      <span style=color:#ae81ff>9</span>      <span style=color:#ae81ff>19</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Percentage of the requests served within a certain time <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> 50%      <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> 66%      <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> 75%     <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> 80%     <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span> 90%     <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span> 95%     <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span> 98%     <span style=color:#ae81ff>19</span>
</span></span><span style=display:flex><span> 99%     <span style=color:#ae81ff>19</span>
</span></span><span style=display:flex><span> 100%     <span style=color:#ae81ff>19</span> <span style=color:#f92672>(</span>longest request<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>2 . 频率限制后(限制为9),<code>ab -n 100 -c 10 localhost/index.php</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> ➜  ~ ab -n <span style=color:#ae81ff>100</span> -c <span style=color:#ae81ff>10</span> localhost/index.php
</span></span><span style=display:flex><span> This is ApacheBench, Version 2.3 &lt;$Revision: <span style=color:#ae81ff>1843412</span> $&gt;
</span></span><span style=display:flex><span> Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span></span><span style=display:flex><span> Licensed to The Apache Software Foundation, http://www.apache.org/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Benchmarking localhost <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>.....done
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Server Software:        openresty
</span></span><span style=display:flex><span> Server Hostname:        localhost
</span></span><span style=display:flex><span> Server Port:            <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Document Path:          /index.php
</span></span><span style=display:flex><span> Document Length:        <span style=color:#ae81ff>3</span> bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Concurrency Level:      <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> Time taken <span style=color:#66d9ef>for</span> tests:   0.088 seconds
</span></span><span style=display:flex><span> Complete requests:      <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span> Failed requests:        <span style=color:#ae81ff>89</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>(</span>Connect: 0, Receive: 0, Length: 89, Exceptions: 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Non-2xx responses:      <span style=color:#ae81ff>89</span>
</span></span><span style=display:flex><span> Total transferred:      <span style=color:#ae81ff>29650</span> bytes
</span></span><span style=display:flex><span> HTML transferred:       <span style=color:#ae81ff>14807</span> bytes
</span></span><span style=display:flex><span> Requests per second:    1131.03 <span style=color:#f92672>[</span><span style=color:#75715e>#/sec] (mean)</span>
</span></span><span style=display:flex><span> Time per request:       8.841 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Time per request:       0.884 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean, across all concurrent requests<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Transfer rate:          327.49 <span style=color:#f92672>[</span>Kbytes/sec<span style=color:#f92672>]</span> received
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Connection Times <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             min  mean<span style=color:#f92672>[</span>+/-sd<span style=color:#f92672>]</span> median   max
</span></span><span style=display:flex><span> Connect:        <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>   0.2      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> Processing:     <span style=color:#ae81ff>4</span>    <span style=color:#ae81ff>8</span>   1.5      <span style=color:#ae81ff>8</span>      <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span> Waiting:        <span style=color:#ae81ff>4</span>    <span style=color:#ae81ff>8</span>   1.5      <span style=color:#ae81ff>8</span>      <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span> Total:          <span style=color:#ae81ff>4</span>    <span style=color:#ae81ff>8</span>   1.5      <span style=color:#ae81ff>8</span>      <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Percentage of the requests served within a certain time <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> 50%      <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span> 66%      <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> 75%      <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> 80%      <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> 90%     <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> 95%     <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> 98%     <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span> 99%     <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span> 100%     <span style=color:#ae81ff>15</span> <span style=color:#f92672>(</span>longest request<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>3 . 频率限制前,<code>ab -n 100 -c 10 -H 'Authorization: Bearer TestToken' localhost/index.php</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> ➜  ~ ab -n <span style=color:#ae81ff>100</span> -c <span style=color:#ae81ff>10</span> -H <span style=color:#e6db74>&#39;Authorization: Bearer TestToken&#39;</span> localhost/index.php
</span></span><span style=display:flex><span> This is ApacheBench, Version 2.3 &lt;$Revision: <span style=color:#ae81ff>1843412</span> $&gt;
</span></span><span style=display:flex><span> Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span></span><span style=display:flex><span> Licensed to The Apache Software Foundation, http://www.apache.org/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Benchmarking localhost <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>.....done
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Server Software:        openresty
</span></span><span style=display:flex><span> Server Hostname:        localhost
</span></span><span style=display:flex><span> Server Port:            <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Document Path:          /index.php
</span></span><span style=display:flex><span> Document Length:        <span style=color:#ae81ff>3</span> bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Concurrency Level:      <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> Time taken <span style=color:#66d9ef>for</span> tests:   0.097 seconds
</span></span><span style=display:flex><span> Complete requests:      <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span> Failed requests:        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> Total transferred:      <span style=color:#ae81ff>16300</span> bytes
</span></span><span style=display:flex><span> HTML transferred:       <span style=color:#ae81ff>300</span> bytes
</span></span><span style=display:flex><span> Requests per second:    1028.65 <span style=color:#f92672>[</span><span style=color:#75715e>#/sec] (mean)</span>
</span></span><span style=display:flex><span> Time per request:       9.721 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Time per request:       0.972 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean, across all concurrent requests<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Transfer rate:          163.74 <span style=color:#f92672>[</span>Kbytes/sec<span style=color:#f92672>]</span> received
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Connection Times <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             min  mean<span style=color:#f92672>[</span>+/-sd<span style=color:#f92672>]</span> median   max
</span></span><span style=display:flex><span> Connect:        <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>   0.1      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> Processing:     <span style=color:#ae81ff>3</span>    <span style=color:#ae81ff>9</span>   1.5      <span style=color:#ae81ff>9</span>      <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span> Waiting:        <span style=color:#ae81ff>2</span>    <span style=color:#ae81ff>9</span>   1.5      <span style=color:#ae81ff>9</span>      <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span> Total:          <span style=color:#ae81ff>3</span>    <span style=color:#ae81ff>9</span>   1.6      <span style=color:#ae81ff>9</span>      <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Percentage of the requests served within a certain time <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> 50%      <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> 66%     <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> 75%     <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> 80%     <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span> 90%     <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span> 95%     <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span> 98%     <span style=color:#ae81ff>13</span>
</span></span><span style=display:flex><span> 99%     <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span> 100%     <span style=color:#ae81ff>14</span> <span style=color:#f92672>(</span>longest request<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>4 . 频率限制后(限制为9),<code>ab -n 100 -c 10 -H 'Authorization: Bearer TestToken' localhost/index.php</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> ➜  ~ ab -n <span style=color:#ae81ff>100</span> -c <span style=color:#ae81ff>10</span> -H <span style=color:#e6db74>&#39;Authorization: Bearer TestToken&#39;</span> localhost/index.php
</span></span><span style=display:flex><span> This is ApacheBench, Version 2.3 &lt;$Revision: <span style=color:#ae81ff>1843412</span> $&gt;
</span></span><span style=display:flex><span> Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span></span><span style=display:flex><span> Licensed to The Apache Software Foundation, http://www.apache.org/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Benchmarking localhost <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>.....done
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Server Software:        openresty
</span></span><span style=display:flex><span> Server Hostname:        localhost
</span></span><span style=display:flex><span> Server Port:            <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Document Path:          /index.php
</span></span><span style=display:flex><span> Document Length:        <span style=color:#ae81ff>3</span> bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Concurrency Level:      <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> Time taken <span style=color:#66d9ef>for</span> tests:   0.076 seconds
</span></span><span style=display:flex><span> Complete requests:      <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span> Failed requests:        <span style=color:#ae81ff>89</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>(</span>Connect: 0, Receive: 0, Length: 89, Exceptions: 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Non-2xx responses:      <span style=color:#ae81ff>89</span>
</span></span><span style=display:flex><span> Total transferred:      <span style=color:#ae81ff>29650</span> bytes
</span></span><span style=display:flex><span> HTML transferred:       <span style=color:#ae81ff>14807</span> bytes
</span></span><span style=display:flex><span> Requests per second:    1307.21 <span style=color:#f92672>[</span><span style=color:#75715e>#/sec] (mean)</span>
</span></span><span style=display:flex><span> Time per request:       7.650 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Time per request:       0.765 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean, across all concurrent requests<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> Transfer rate:          378.50 <span style=color:#f92672>[</span>Kbytes/sec<span style=color:#f92672>]</span> received
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Connection Times <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             min  mean<span style=color:#f92672>[</span>+/-sd<span style=color:#f92672>]</span> median   max
</span></span><span style=display:flex><span> Connect:        <span style=color:#ae81ff>0</span>    <span style=color:#ae81ff>0</span>   0.1      <span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> Processing:     <span style=color:#ae81ff>2</span>    <span style=color:#ae81ff>7</span>   1.2      <span style=color:#ae81ff>7</span>      <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span> Waiting:        <span style=color:#ae81ff>2</span>    <span style=color:#ae81ff>7</span>   1.2      <span style=color:#ae81ff>7</span>      <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span> Total:          <span style=color:#ae81ff>2</span>    <span style=color:#ae81ff>7</span>   1.2      <span style=color:#ae81ff>7</span>      <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Percentage of the requests served within a certain time <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span> 50%      <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span> 66%      <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span> 75%      <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span> 80%      <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span> 90%      <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span> 95%      <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span> 98%     <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span> 99%     <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span> 100%     <span style=color:#ae81ff>14</span> <span style=color:#f92672>(</span>longest request<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>5 . 在redis-cli中也可以获取到<code>block</code>数据</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> 127.0.0.1:6379&gt; get userIp:172.27.0.1:block
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span></code></pre></div><h2 id=其他>其他<a hidden class=anchor aria-hidden=true href=#其他>#</a></h2><ul><li>以上请求频率限制+自动拉黑一段时间的方式可以一定程度上拦截一些恶意请求,误伤小,让通过脚本携带token/cookie进行大量请求攻击难度变大</li><li>最近把自己本地的<a href=https://github.com/lestat220255/allindocker>开发环境</a>发布到了github上,以方便在任何地方都可以快速搭建自己用着顺手的开发环境</li><li>redis的key太长(目前用token作为key)会明显影响性能吗?答案是:<strong>不会</strong> <a href=https://stackoverflow.com/questions/6320739/does-name-length-impact-performance-in-redis>参考网址</a></li><li>关于docker容器内的DNS服务器地址为<code>127.0.0.11</code>的<a href=https://docs.docker.com/v17.09/engine/userguide/networking/configure-dns/>官方说明</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.88886688.xyz/tags/openresty/>openresty</a></li></ul><nav class=paginav><a class=prev href=https://blog.88886688.xyz/posts/2019-03-08-laravel%E5%9F%BA%E4%BA%8Eredis%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%A7%92%E6%9D%80%E5%AE%9E%E7%8E%B0/><span class=title>« Prev</span><br><span>laravel基于redis的分布式秒杀系统</span></a>
<a class=next href=https://blog.88886688.xyz/posts/2019-02-19-mysql%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/><span class=title>Next »</span><br><span>mysql实现主从复制</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2017-2023 <a href=https://blog.88886688.xyz/>Lester's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><br><span>Email: <a href=mailto:lestat9527@gmail.com>lestat9527@gmail.com</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>